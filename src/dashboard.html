<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Yam - Bitcoin P2P Dashboard</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js" integrity="sha384-jb8JQMbMoBUzgWatfe6COACi2ljcDdZQ2OxczGA3bGNeWe+6DChMTBJemed7ZnvJ" crossorigin="anonymous"></script>
    <script src="https://d3js.org/d3.v7.min.js" integrity="sha384-CjloA8y00+1SDAUkjs099PVfnY2KmDC2BZnws9kh8D/lX1s46w6EPhpXdqMfjK6i" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha384-sHL9NAb7lN7rfvG5lfHpm643Xkcjzp4jFvuavGOndn6pjVqS6ny56CAt3nsEVT4H" crossorigin="anonymous" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha384-cxOPjt7s7Iz04uaHJceBmS+qpjv2JkIHNVcuOrM+YHwZOmJGBXI00mdUXEq65HTH" crossorigin="anonymous"></script>
    <style>
        :root {
            --bg: #1a1a2e;
            --card-bg: #16213e;
            --text: #eee;
            --text-muted: #888;
            --accent: #e94560;
            --success: #4ecca3;
            --warning: #ffc107;
            --error: #e94560;
            --border: rgba(255,255,255,0.1);
            --input-bg: rgba(0,0,0,0.3);
        }
        [data-theme="light"] {
            --bg: #f5f5f5;
            --card-bg: #ffffff;
            --text: #222;
            --text-muted: #666;
            --border: rgba(0,0,0,0.1);
            --input-bg: rgba(0,0,0,0.05);
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', system-ui, sans-serif;
            background: var(--bg);
            color: var(--text);
            min-height: 100vh;
            padding: 20px;
        }
        .header { text-align: center; margin-bottom: 30px; position: relative; }
        .header h1 { font-size: 2.5rem; }
        .header .subtitle { color: var(--text-muted); margin-top: 5px; }
        .header-controls { margin-top: 15px; display: flex; justify-content: center; gap: 10px; }
        .header-btn {
            padding: 6px 12px;
            border: 1px solid var(--border);
            border-radius: 6px;
            background: var(--card-bg);
            color: var(--text);
            cursor: pointer;
            font-size: 0.8rem;
        }
        .header-btn:hover { border-color: var(--accent); }
        .block-badge {
            display: none;
            position: fixed;
            top: 50px;
            right: 10px;
            padding: 10px 15px;
            background: var(--success);
            color: #000;
            border-radius: 8px;
            font-weight: bold;
            animation: fadeIn 0.3s;
        }
        .block-badge.show { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }
        .card {
            background: var(--card-bg);
            border-radius: 12px;
            padding: 20px;
        }
        .card h2 {
            font-size: 1.1rem;
            color: var(--text-muted);
            margin-bottom: 15px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        .stat-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
        }
        .stat { text-align: center; }
        .stat .value { font-size: 2rem; font-weight: bold; }
        .stat .label { font-size: 0.8rem; color: var(--text-muted); }
        .stat.connected .value { color: var(--success); }
        .stat.connecting .value { color: var(--warning); }
        .stat.failed .value { color: var(--error); }
        .node-list { max-height: 400px; overflow-y: auto; }
        .node-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
        }
        .node-item:last-child { border-bottom: none; }
        .node-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .node-addr { font-family: monospace; font-size: 0.85rem; word-break: break-all; }
        .node-status {
            padding: 3px 8px;
            border-radius: 4px;
            font-size: 0.75rem;
            text-transform: uppercase;
        }
        .node-status.connected { background: var(--success); color: #000; }
        .node-status.connecting, .node-status.handshaking { background: var(--warning); color: #000; }
        .node-status.failed { background: var(--error); }
        .node-latency { color: var(--text-muted); font-size: 0.85rem; margin-right: 8px; }
        .node-bandwidth {
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-top: 4px;
            font-family: monospace;
        }
        .node-bandwidth span { margin-right: 10px; }
        .node-bandwidth .in { color: var(--success); }
        .node-bandwidth .out { color: var(--warning); }
        .tx-list { max-height: 300px; overflow-y: auto; }
        .tx-item {
            padding: 10px;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
        }
        .tx-item:hover { background: rgba(255,255,255,0.03); }
        .tx-item:last-child { border-bottom: none; }
        .tx-id {
            font-family: monospace;
            font-size: 0.75rem;
            word-break: break-all;
            color: var(--accent);
        }
        .tx-details {
            display: none;
            margin-top: 8px;
            padding: 8px;
            background: rgba(0,0,0,0.3);
            border-radius: 4px;
        }
        .tx-item.expanded .tx-details { display: block; }
        .tx-hex {
            font-family: monospace;
            font-size: 0.65rem;
            word-break: break-all;
            color: var(--text-muted);
            max-height: 100px;
            overflow-y: auto;
        }
        .tx-size { font-size: 0.75rem; color: var(--warning); margin-bottom: 6px; }
        .tx-meta {
            display: flex;
            justify-content: space-between;
            margin-top: 5px;
            font-size: 0.75rem;
            color: var(--text-muted);
        }
        .tx-propagation {
            font-size: 0.7rem;
            color: var(--success);
            margin-top: 4px;
            font-family: monospace;
        }
        .tx-item.fee-low { border-left: 3px solid #4ecca3; }
        .tx-item.fee-medium { border-left: 3px solid #ffc107; }
        .tx-item.fee-high { border-left: 3px solid #e94560; }
        .tx-fee { font-size: 0.7rem; color: var(--text-muted); margin-top: 2px; }
        .tx-type-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; font-weight: bold; background: var(--accent); color: #fff; margin-left: 6px; }
        .tx-detail-row { display: flex; justify-content: space-between; font-size: 0.75rem; padding: 4px 0; border-bottom: 1px solid var(--border); }
        .tx-detail-row:last-child { border-bottom: none; }
        .tx-detail-label { color: var(--text-muted); }
        .tx-detail-value { font-family: monospace; }
        .tx-actions { display: flex; gap: 8px; margin-top: 8px; }
        .tx-action-btn { padding: 4px 8px; font-size: 0.7rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; }
        .tx-action-btn:hover { border-color: var(--accent); }
        .quality-dot { display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 6px; }
        .quality-dot.excellent { background: #4ecca3; }
        .quality-dot.good { background: #a3e048; }
        .quality-dot.fair { background: #ffc107; }
        .quality-dot.poor { background: #e94560; }
        .quality-tooltip { position: relative; cursor: help; }
        .quality-tooltip .tooltip-text { visibility: hidden; position: absolute; bottom: 125%; left: 50%; transform: translateX(-50%); background: var(--card-bg); border: 1px solid var(--border); padding: 8px; border-radius: 6px; font-size: 0.7rem; white-space: nowrap; z-index: 100; box-shadow: 0 2px 8px rgba(0,0,0,0.3); }
        .quality-tooltip:hover .tooltip-text { visibility: visible; }
        .node-sort { display: flex; gap: 8px; margin-bottom: 10px; flex-wrap: wrap; }
        .node-sort-btn { padding: 4px 8px; font-size: 0.7rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; }
        .node-sort-btn.active { border-color: var(--accent); background: var(--accent); color: #fff; }
        .node-sort-btn:hover { border-color: var(--accent); }
        .tx-search {
            width: 100%;
            padding: 8px 12px;
            margin-bottom: 10px;
            background: var(--input-bg);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-family: monospace;
            font-size: 0.85rem;
        }
        .tx-search::placeholder { color: var(--text-muted); }
        .tx-search:focus { outline: none; border-color: var(--accent); }
        .chart-container { height: 200px; margin-top: 15px; }
        .ws-status {
            position: fixed;
            top: 10px;
            right: 10px;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 0.85rem;
        }
        .ws-status.connected { background: var(--success); color: #000; }
        .ws-status.disconnected { background: var(--error); }
        .ws-status.connecting { background: var(--warning); color: #000; }
        .empty { color: var(--text-muted); text-align: center; padding: 20px; }
        .block-hash {
            font-family: monospace;
            font-size: 0.7rem;
            word-break: break-all;
            color: var(--text-muted);
            margin-top: 15px;
            padding: 10px;
            background: var(--input-bg);
            border-radius: 6px;
        }
        .card.map-card { grid-column: 1 / -1; }
        #peer-map { height: 300px; border-radius: 8px; background: #0d1117; }
        .sync-bar { height: 8px; background: var(--input-bg); border-radius: 4px; margin: 15px 0; overflow: hidden; }
        .sync-bar-fill { height: 100%; background: var(--success); transition: width 0.3s; }
        .sync-badge { display: inline-block; padding: 4px 10px; border-radius: 12px; font-size: 0.75rem; font-weight: bold; }
        .sync-badge.synced { background: var(--success); color: #000; }
        .sync-badge.syncing { background: var(--warning); color: #000; }
        .sync-info { font-size: 0.85rem; color: var(--text-muted); margin-top: 10px; text-align: center; }
        .card.topology-card { grid-column: 1 / -1; }
        .card.topology-card.hidden { display: none; }
        #topology-graph { width: 100%; height: 400px; border-radius: 8px; background: var(--input-bg); }
        .topology-node { cursor: pointer; }
        .topology-node.self { fill: var(--accent); }
        .topology-node.peer { fill: var(--success); }
        .topology-node.highlighted { stroke: var(--warning); stroke-width: 3px; }
        .topology-link { stroke: var(--border); stroke-opacity: 0.6; }
        .topology-link.highlighted { stroke: var(--warning); stroke-opacity: 1; }
        .topology-label { font-size: 10px; fill: var(--text); pointer-events: none; }
        .topology-tooltip { position: absolute; background: var(--card-bg); border: 1px solid var(--border); padding: 10px; border-radius: 6px; font-size: 0.8rem; pointer-events: none; z-index: 1000; box-shadow: 0 4px 12px rgba(0,0,0,0.3); }
        .topology-tooltip h4 { margin-bottom: 6px; color: var(--accent); }
        .topology-tooltip p { margin: 2px 0; color: var(--text-muted); }
        .topology-legend { display: flex; gap: 20px; margin-top: 10px; font-size: 0.8rem; color: var(--text-muted); }
        .topology-legend-item { display: flex; align-items: center; gap: 6px; }
        .topology-legend-dot { width: 12px; height: 12px; border-radius: 50%; }
        .topology-legend-dot.self { background: var(--accent); }
        .topology-legend-dot.peer { background: var(--success); }
        .topology-legend-dot.tx { background: var(--warning); }
        .header-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
        .tx-path-list { max-height: 150px; overflow-y: auto; margin-top: 10px; }
        .tx-path-item { padding: 6px 10px; background: var(--input-bg); border-radius: 4px; margin-bottom: 4px; font-size: 0.75rem; cursor: pointer; }
        .tx-path-item:hover { border-left: 2px solid var(--accent); }
        .tx-path-item.active { border-left: 2px solid var(--warning); background: rgba(255,193,7,0.1); }
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 2000; align-items: center; justify-content: center; }
        .modal-overlay.show { display: flex; }
        .modal { background: var(--card-bg); border-radius: 12px; padding: 24px; max-width: 400px; width: 90%; }
        .modal h3 { margin-bottom: 12px; color: var(--accent); }
        .modal p { margin-bottom: 16px; color: var(--text-muted); font-size: 0.9rem; }
        .modal-actions { display: flex; gap: 10px; justify-content: flex-end; }
        .modal-btn { padding: 8px 16px; border-radius: 6px; border: 1px solid var(--border); background: var(--card-bg); color: var(--text); cursor: pointer; font-size: 0.85rem; }
        .modal-btn:hover { border-color: var(--accent); }
        .modal-btn.danger { background: var(--error); border-color: var(--error); color: #fff; }
        .modal-btn.danger:hover { opacity: 0.9; }
        .toast-container { position: fixed; bottom: 20px; right: 20px; z-index: 3000; display: flex; flex-direction: column; gap: 8px; }
        .toast { padding: 12px 20px; border-radius: 8px; background: var(--card-bg); border: 1px solid var(--border); color: var(--text); font-size: 0.85rem; animation: slideIn 0.3s; }
        .toast.success { border-color: var(--success); background: rgba(78,204,163,0.15); }
        .toast.error { border-color: var(--error); background: rgba(233,69,96,0.15); }
        @keyframes slideIn { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        .global-search { position: relative; width: 280px; }
        .global-search-input { width: 100%; padding: 8px 12px 8px 32px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); font-family: monospace; font-size: 0.85rem; }
        .global-search-input::placeholder { color: var(--text-muted); }
        .global-search-input:focus { outline: none; border-color: var(--accent); }
        .global-search-icon { position: absolute; left: 10px; top: 50%; transform: translateY(-50%); color: var(--text-muted); font-size: 0.85rem; pointer-events: none; }
        .global-search-kbd { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); font-size: 0.65rem; padding: 2px 5px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 3px; color: var(--text-muted); }
        .search-modal { background: var(--card-bg); border-radius: 12px; padding: 0; max-width: 600px; width: 90%; max-height: 70vh; overflow: hidden; display: flex; flex-direction: column; }
        .search-modal-header { padding: 16px; border-bottom: 1px solid var(--border); }
        .search-modal-input { width: 100%; padding: 12px 16px 12px 40px; background: var(--input-bg); border: 1px solid var(--border); border-radius: 8px; color: var(--text); font-family: monospace; font-size: 1rem; }
        .search-modal-input:focus { outline: none; border-color: var(--accent); }
        .search-modal-icon { position: absolute; left: 28px; top: 28px; color: var(--text-muted); font-size: 1rem; }
        .search-modal-body { flex: 1; overflow-y: auto; padding: 12px 0; }
        .search-section { padding: 0 16px; }
        .search-section-title { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; letter-spacing: 1px; margin-bottom: 8px; }
        .search-result { padding: 10px 16px; cursor: pointer; border-radius: 6px; margin: 0 8px 4px; }
        .search-result:hover { background: var(--input-bg); }
        .search-result-type { font-size: 0.7rem; color: var(--accent); text-transform: uppercase; margin-bottom: 2px; }
        .search-result-value { font-family: monospace; font-size: 0.85rem; word-break: break-all; }
        .search-result-meta { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .search-empty { padding: 40px 16px; text-align: center; color: var(--text-muted); }
        .search-history-item { display: flex; justify-content: space-between; align-items: center; }
        .search-history-clear { font-size: 0.7rem; color: var(--text-muted); cursor: pointer; padding: 2px 6px; }
        .search-history-clear:hover { color: var(--error); }
        .settings-modal { background: var(--card-bg); border-radius: 12px; padding: 0; max-width: 480px; width: 90%; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
        .settings-modal-header { padding: 16px 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
        .settings-modal-header h3 { margin: 0; color: var(--accent); }
        .settings-modal-close { background: none; border: none; color: var(--text-muted); font-size: 1.2rem; cursor: pointer; padding: 4px 8px; }
        .settings-modal-close:hover { color: var(--text); }
        .settings-modal-body { flex: 1; overflow-y: auto; padding: 16px 20px; }
        .settings-modal-footer { padding: 12px 20px; border-top: 1px solid var(--border); display: flex; justify-content: flex-end; gap: 10px; }
        .settings-select { padding: 6px 10px; font-size: 0.85rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 6px; color: var(--text); cursor: pointer; min-width: 120px; }
        .settings-select:focus { outline: none; border-color: var(--accent); }
        .settings-toggle { position: relative; width: 44px; height: 24px; background: var(--input-bg); border-radius: 12px; cursor: pointer; border: 1px solid var(--border); transition: background 0.2s; }
        .settings-toggle.active { background: var(--accent); border-color: var(--accent); }
        .settings-toggle::after { content: ''; position: absolute; top: 2px; left: 2px; width: 18px; height: 18px; background: var(--text); border-radius: 50%; transition: transform 0.2s; }
        .settings-toggle.active::after { transform: translateX(20px); background: #fff; }
        .settings-icon-btn { background: none; border: 1px solid var(--border); border-radius: 6px; padding: 6px 10px; cursor: pointer; color: var(--text-muted); font-size: 1rem; }
        .settings-icon-btn:hover { border-color: var(--accent); color: var(--text); }
        body.compact .card { padding: 12px; }
        body.compact .stat .value { font-size: 1.5rem; }
        body.compact .node-item { padding: 6px 10px; }
        body.compact .tx-item { padding: 6px 10px; }
        body.compact .grid { gap: 12px; }
        .node-actions { display: flex; gap: 4px; margin-left: 8px; }
        .node-action-btn { padding: 2px 6px; font-size: 0.7rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text-muted); cursor: pointer; }
        .node-action-btn:hover { border-color: var(--accent); color: var(--text); }
        .node-action-btn.danger:hover { border-color: var(--error); color: var(--error); }
        .ban-select { padding: 2px 4px; font-size: 0.7rem; background: var(--input-bg); border: 1px solid var(--border); border-radius: 4px; color: var(--text); cursor: pointer; }
        .banned-list { max-height: 200px; overflow-y: auto; }
        .banned-item { display: flex; justify-content: space-between; align-items: center; padding: 8px; border-bottom: 1px solid var(--border); font-size: 0.8rem; }
        .banned-item:last-child { border-bottom: none; }
        .banned-addr { font-family: monospace; color: var(--text-muted); }
        .banned-time { font-size: 0.7rem; color: var(--warning); }
        .tx-item.spam { border-left: 3px solid var(--warning); background: rgba(255,193,7,0.05); }
        .spam-icon { color: var(--warning); margin-left: 6px; cursor: help; }
        .spam-filter { display: flex; align-items: center; gap: 8px; margin-bottom: 10px; font-size: 0.8rem; }
        .spam-filter input { width: 16px; height: 16px; cursor: pointer; }
        .spam-badge { display: inline-block; padding: 2px 6px; border-radius: 4px; font-size: 0.65rem; background: var(--warning); color: #000; margin-left: 4px; }
        .health-charts { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; }
        .health-chart { height: 150px; }
        .tab-bar { display: flex; gap: 0; margin-bottom: 20px; border-bottom: 2px solid var(--border); max-width: 1400px; margin-left: auto; margin-right: auto; }
        .tab-btn { padding: 12px 24px; background: none; border: none; color: var(--text-muted); cursor: pointer; font-size: 0.9rem; position: relative; transition: color 0.2s; }
        .tab-btn:hover { color: var(--text); }
        .tab-btn.active { color: var(--accent); }
        .tab-btn.active::after { content: ''; position: absolute; bottom: -2px; left: 0; right: 0; height: 2px; background: var(--accent); }
        .tab-btn kbd { font-size: 0.65rem; padding: 2px 5px; background: var(--input-bg); border-radius: 3px; margin-left: 6px; opacity: 0.5; }
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
        .settings-section { margin-bottom: 24px; }
        .settings-section h3 { margin-bottom: 12px; font-size: 1rem; color: var(--text); }
        .settings-row { display: flex; justify-content: space-between; align-items: center; padding: 10px 0; border-bottom: 1px solid var(--border); }
        .settings-row:last-child { border-bottom: none; }
        .settings-label { color: var(--text-muted); font-size: 0.85rem; }
        .settings-value { font-size: 0.85rem; }
    </style>
</head>
<body>
    <div class="modal-overlay" id="modal-overlay" onclick="if(event.target===this)closeModal()">
        <div class="modal" id="modal">
            <h3 id="modal-title">Confirm Action</h3>
            <p id="modal-message">Are you sure?</p>
            <div class="modal-actions">
                <button class="modal-btn" onclick="closeModal()">Cancel</button>
                <button class="modal-btn danger" id="modal-confirm">Confirm</button>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="search-modal-overlay" onclick="if(event.target===this)closeSearchModal()">
        <div class="search-modal">
            <div class="search-modal-header" style="position:relative">
                <span class="search-modal-icon">&#128269;</span>
                <input type="text" id="search-modal-input" class="search-modal-input" placeholder="Search txid, prefix, or block hash..." autocomplete="off">
            </div>
            <div class="search-modal-body" id="search-modal-body">
                <div class="search-empty">Type to search transactions or blocks</div>
            </div>
        </div>
    </div>
    <div class="modal-overlay" id="settings-modal-overlay" onclick="if(event.target===this)closeSettingsModal()">
        <div class="settings-modal">
            <div class="settings-modal-header">
                <h3>Settings</h3>
                <button class="settings-modal-close" onclick="closeSettingsModal()">&times;</button>
            </div>
            <div class="settings-modal-body">
                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="settings-row">
                        <span class="settings-label">Theme</span>
                        <select class="settings-select" id="setting-theme" onchange="applySetting('theme',this.value)">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Compact Mode</span>
                        <div class="settings-toggle" id="setting-compact" onclick="toggleSetting('compact')"></div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Chart Animations</span>
                        <div class="settings-toggle active" id="setting-animations" onclick="toggleSetting('animations')"></div>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Data</h3>
                    <div class="settings-row">
                        <span class="settings-label">Refresh Interval</span>
                        <select class="settings-select" id="setting-refresh" onchange="applySetting('refresh',this.value)">
                            <option value="1000">1 second</option>
                            <option value="2000" selected>2 seconds</option>
                            <option value="5000">5 seconds</option>
                            <option value="10000">10 seconds</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Max Transactions</span>
                        <select class="settings-select" id="setting-maxTxs" onchange="applySetting('maxTxs',this.value)">
                            <option value="20">20</option>
                            <option value="50" selected>50</option>
                            <option value="100">100</option>
                        </select>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Geolocation API</span>
                        <select class="settings-select" id="setting-geoApi" onchange="applySetting('geoApi',this.value)">
                            <option value="ip-api">ip-api.com</option>
                            <option value="ipinfo">ipinfo.io</option>
                            <option value="none">Disabled</option>
                        </select>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Notifications</h3>
                    <div class="settings-row">
                        <span class="settings-label">Audio Notifications</span>
                        <div class="settings-toggle" id="setting-audio" onclick="toggleSetting('audio')"></div>
                    </div>
                </div>
                <div class="settings-section" id="state-section" style="display:none">
                    <h3>Persistent State</h3>
                    <div class="settings-row">
                        <span class="settings-label">Clear all saved state (peers, bans, blocks)</span>
                        <button class="modal-btn" style="background:#dc3545;border-color:#dc3545;color:#fff" onclick="clearState()">Clear State</button>
                    </div>
                </div>
            </div>
            <div class="settings-modal-footer">
                <button class="modal-btn" onclick="resetSettings()">Reset to Defaults</button>
                <button class="modal-btn" style="background:var(--accent);border-color:var(--accent);color:#fff" onclick="closeSettingsModal()">Done</button>
            </div>
        </div>
    </div>
    <div class="toast-container" id="toast-container"></div>
    <div class="ws-status connecting" id="ws-status">Connecting...</div>
    <div class="header">
        <h1>Yam</h1>
        <p class="subtitle">Bitcoin P2P Network Dashboard</p>
        <div class="global-search" style="margin: 15px auto 0;">
            <span class="global-search-icon">&#128269;</span>
            <input type="text" id="global-search-input" class="global-search-input" placeholder="Search txid or block..." readonly onclick="openSearchModal()">
            <span class="global-search-kbd">Ctrl+K</span>
        </div>
        <div class="header-controls">
            <button class="header-btn" id="theme-btn" onclick="toggleTheme()">Light</button>
            <button class="header-btn" id="topology-btn" onclick="toggleTopology()">Topology</button>
            <button class="header-btn" onclick="exportNodes('json')">Nodes JSON</button>
            <button class="header-btn" onclick="exportNodes('csv')">Nodes CSV</button>
            <button class="header-btn" onclick="exportTxs('json')">Txs JSON</button>
            <button class="settings-icon-btn" onclick="openSettingsModal()" title="Settings">&#9881;</button>
        </div>
    </div>
    <div class="block-badge" id="block-badge">New Block!</div>
    <nav class="tab-bar">
        <button class="tab-btn active" data-tab="overview" onclick="switchTab('overview')">Overview<kbd>1</kbd></button>
        <button class="tab-btn" data-tab="nodes" onclick="switchTab('nodes')">Nodes<kbd>2</kbd></button>
        <button class="tab-btn" data-tab="mempool" onclick="switchTab('mempool')">Mempool<kbd>3</kbd></button>
        <button class="tab-btn" data-tab="transactions" onclick="switchTab('transactions')">Transactions<kbd>4</kbd></button>
        <button class="tab-btn" data-tab="settings" onclick="switchTab('settings')">Settings<kbd>5</kbd></button>
    </nav>
    <div id="tab-overview" class="tab-panel active">
    <div class="grid">
        <div class="card">
            <h2>Network Status</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="total-nodes">0</div>
                    <div class="label">Known Nodes</div>
                </div>
                <div class="stat connected">
                    <div class="value" id="connected-nodes">0</div>
                    <div class="label">Connected</div>
                </div>
                <div class="stat connecting">
                    <div class="value" id="connecting-nodes">0</div>
                    <div class="label">Connecting</div>
                </div>
                <div class="stat failed">
                    <div class="value" id="failed-nodes">0</div>
                    <div class="label">Failed</div>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>Mempool</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="mempool-count">0</div>
                    <div class="label">Transactions</div>
                </div>
                <div class="stat">
                    <div class="value" id="mempool-size">0 MB</div>
                    <div class="label">Size (vMB)</div>
                </div>
                <div class="stat">
                    <div class="value" id="mempool-memory">0 MB</div>
                    <div class="label">Memory Est.</div>
                </div>
            </div>
            <div class="chart-container" style="height:100px">
                <canvas id="mempool-chart"></canvas>
            </div>
            <div class="chart-container" style="height:80px">
                <canvas id="mempool-size-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Sync Status</h2>
            <div style="text-align:center;margin-bottom:10px">
                <span class="sync-badge syncing" id="sync-badge">Connecting...</span>
            </div>
            <div class="sync-bar">
                <div class="sync-bar-fill" id="sync-bar-fill" style="width:0%"></div>
            </div>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="sync-height">0</div>
                    <div class="label">Blocks Seen</div>
                </div>
                <div class="stat">
                    <div class="value" id="sync-highest">0</div>
                    <div class="label">Network Height</div>
                </div>
            </div>
            <div class="sync-info" id="sync-info">Waiting for peers...</div>
        </div>
        <div class="card">
            <h2>Latest Block</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="blocks-seen">0</div>
                    <div class="label">Blocks Seen</div>
                </div>
                <div class="stat">
                    <div class="value" id="time-since-block">-</div>
                    <div class="label">Time Since Block</div>
                </div>
            </div>
            <div class="block-hash" id="block-hash">Waiting for block...</div>
        </div>
        <div class="card">
            <h2>Network Statistics</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="total-bandwidth-in">0 MB</div>
                    <div class="label">Total In</div>
                </div>
                <div class="stat">
                    <div class="value" id="total-bandwidth-out">0 MB</div>
                    <div class="label">Total Out</div>
                </div>
                <div class="stat">
                    <div class="value" id="total-msgs">0</div>
                    <div class="label">Messages</div>
                </div>
                <div class="stat">
                    <div class="value" id="avg-latency">- ms</div>
                    <div class="label">Avg Latency</div>
                </div>
            </div>
            <div class="stat-grid" style="margin-top:10px">
                <div class="stat">
                    <div class="value" id="session-uptime">0h 0m</div>
                    <div class="label">Session Uptime</div>
                </div>
            </div>
            <div class="chart-container" style="height:100px">
                <canvas id="bandwidth-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Message Types</h2>
            <div class="chart-container" style="height:180px">
                <canvas id="msg-type-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Block Time History</h2>
            <div class="chart-container">
                <canvas id="blocktime-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Transaction Sizes</h2>
            <div class="chart-container">
                <canvas id="txsize-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Fee Rates</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="median-fee">-</div>
                    <div class="label">Median (sat/vB)</div>
                </div>
                <div class="stat">
                    <div class="value" id="fee-tx-count">0</div>
                    <div class="label">Txs w/ Fee Data</div>
                </div>
            </div>
            <div class="chart-container" style="height:150px">
                <canvas id="fee-dist-chart"></canvas>
            </div>
            <div class="chart-container" style="height:120px">
                <canvas id="fee-history-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Mempool Health</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="spam-pct">0%</div>
                    <div class="label">Spam Rate</div>
                </div>
                <div class="stat">
                    <div class="value" id="spam-count">0</div>
                    <div class="label">Spam Txs</div>
                </div>
            </div>
            <div class="health-charts">
                <div class="health-chart">
                    <canvas id="spam-pie-chart"></canvas>
                </div>
                <div class="health-chart">
                    <canvas id="spam-history-chart"></canvas>
                </div>
            </div>
        </div>
        <div class="card">
            <h2>Peer Quality</h2>
            <div class="stat-grid">
                <div class="stat">
                    <div class="value" id="avg-quality">-</div>
                    <div class="label">Avg Score</div>
                </div>
                <div class="stat">
                    <div class="value" id="quality-count">0</div>
                    <div class="label">Peers Scored</div>
                </div>
            </div>
            <div class="chart-container" style="height:150px">
                <canvas id="quality-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Connected Nodes</h2>
            <div class="node-sort">
                <button class="node-sort-btn active" onclick="setNodeSort('default')">Default</button>
                <button class="node-sort-btn" onclick="setNodeSort('quality')">Quality</button>
                <button class="node-sort-btn" onclick="setNodeSort('latency')">Latency</button>
                <button class="node-sort-btn" onclick="setNodeSort('bandwidth')">Bandwidth</button>
            </div>
            <div class="node-list" id="node-list">
                <div class="empty">No nodes connected yet</div>
            </div>
        </div>
        <div class="card">
            <h2>Banned Peers <span id="banned-count" style="font-size:0.8rem;color:var(--text-muted)">(0)</span></h2>
            <div class="banned-list" id="banned-list">
                <div class="empty">No banned peers</div>
            </div>
        </div>
        <div class="card">
            <h2>User Agents</h2>
            <div style="font-size:0.75rem;color:var(--text-muted);margin-bottom:8px">Format: Agent (count, percentage)</div>
            <div class="chart-container">
                <canvas id="ua-chart"></canvas>
            </div>
        </div>
        <div class="card">
            <h2>Recent Transactions</h2>
            <input type="text" id="tx-search" class="tx-search" placeholder="Filter by txid prefix...">
            <div class="spam-filter">
                <input type="checkbox" id="hide-spam" onchange="renderTxList()">
                <label for="hide-spam">Hide spam</label>
            </div>
            <div class="tx-list" id="tx-list">
                <div class="empty">No transactions yet</div>
            </div>
        </div>
        <div class="card topology-card hidden" id="topology-card">
            <h2>Network Topology</h2>
            <div id="topology-graph"></div>
            <div class="topology-legend">
                <div class="topology-legend-item"><span class="topology-legend-dot self"></span> Your Node</div>
                <div class="topology-legend-item"><span class="topology-legend-dot peer"></span> Connected Peers</div>
                <div class="topology-legend-item"><span class="topology-legend-dot tx"></span> Tx Propagation</div>
            </div>
            <div class="tx-path-list" id="tx-path-list"></div>
        </div>
        <div class="card map-card">
            <h2>Peer Locations</h2>
            <div id="peer-map"></div>
        </div>
    </div>
    </div>
    <div id="tab-nodes" class="tab-panel">
        <div class="grid">
            <div class="card" style="grid-column: 1 / -1">
                <h2>Node Management</h2>
                <div class="node-sort" style="margin-bottom:15px">
                    <button class="node-sort-btn active" onclick="setNodeSort('default')">Default</button>
                    <button class="node-sort-btn" onclick="setNodeSort('quality')">Quality</button>
                    <button class="node-sort-btn" onclick="setNodeSort('latency')">Latency</button>
                    <button class="node-sort-btn" onclick="setNodeSort('bandwidth')">Bandwidth</button>
                </div>
                <div class="node-list" id="node-list-detail" style="max-height:500px"></div>
            </div>
            <div class="card">
                <h2>Peer Quality Distribution</h2>
                <div class="chart-container" style="height:200px">
                    <canvas id="quality-chart-detail"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>Banned Peers <span id="banned-count-detail" style="font-size:0.8rem;color:var(--text-muted)">(0)</span></h2>
                <div class="banned-list" id="banned-list-detail" style="max-height:200px">
                    <div class="empty">No banned peers</div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-mempool" class="tab-panel">
        <div class="grid">
            <div class="card">
                <h2>Mempool Overview</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="value" id="mempool-count-detail">0</div>
                        <div class="label">Transactions</div>
                    </div>
                    <div class="stat">
                        <div class="value" id="mempool-size-detail">0 MB</div>
                        <div class="label">Size (vMB)</div>
                    </div>
                    <div class="stat">
                        <div class="value" id="mempool-memory-detail">0 MB</div>
                        <div class="label">Memory Est.</div>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Fee Distribution</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="value" id="median-fee-detail">-</div>
                        <div class="label">Median (sat/vB)</div>
                    </div>
                    <div class="stat">
                        <div class="value" id="fee-tx-count-detail">0</div>
                        <div class="label">Txs w/ Fee Data</div>
                    </div>
                </div>
                <div class="chart-container" style="height:200px">
                    <canvas id="fee-dist-chart-detail"></canvas>
                </div>
            </div>
            <div class="card">
                <h2>Mempool Health</h2>
                <div class="stat-grid">
                    <div class="stat">
                        <div class="value" id="spam-pct-detail">0%</div>
                        <div class="label">Spam Rate</div>
                    </div>
                    <div class="stat">
                        <div class="value" id="spam-count-detail">0</div>
                        <div class="label">Spam Txs</div>
                    </div>
                </div>
                <div class="health-charts">
                    <div class="health-chart">
                        <canvas id="spam-pie-chart-detail"></canvas>
                    </div>
                    <div class="health-chart">
                        <canvas id="spam-history-chart-detail"></canvas>
                    </div>
                </div>
            </div>
            <div class="card">
                <h2>Size History</h2>
                <div class="chart-container" style="height:200px">
                    <canvas id="mempool-size-chart-detail"></canvas>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-transactions" class="tab-panel">
        <div class="grid">
            <div class="card" style="grid-column: 1 / -1">
                <h2>Transaction Explorer</h2>
                <input type="text" id="tx-search-detail" class="tx-search" placeholder="Filter by txid prefix...">
                <div class="spam-filter">
                    <input type="checkbox" id="hide-spam-detail" onchange="renderTxListDetail(true)">
                    <label for="hide-spam-detail">Hide spam</label>
                </div>
                <div class="tx-list" id="tx-list-detail" style="max-height:600px">
                    <div class="empty">No transactions yet</div>
                </div>
            </div>
        </div>
    </div>
    <div id="tab-settings" class="tab-panel">
        <div class="grid">
            <div class="card" style="grid-column: 1 / -1">
                <h2>Dashboard Settings</h2>
                <div class="settings-section">
                    <h3>Appearance</h3>
                    <div class="settings-row">
                        <span class="settings-label">Theme</span>
                        <button class="header-btn" id="theme-btn-settings" onclick="toggleTheme()">Light</button>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Data</h3>
                    <div class="settings-row">
                        <span class="settings-label">Export Nodes</span>
                        <div>
                            <button class="header-btn" onclick="exportNodes('json')">JSON</button>
                            <button class="header-btn" onclick="exportNodes('csv')">CSV</button>
                        </div>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Export Transactions</span>
                        <button class="header-btn" onclick="exportTxs('json')">JSON</button>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>Keyboard Shortcuts</h3>
                    <div class="settings-row">
                        <span class="settings-label">Overview tab</span>
                        <span class="settings-value"><kbd>1</kbd></span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Nodes tab</span>
                        <span class="settings-value"><kbd>2</kbd></span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Mempool tab</span>
                        <span class="settings-value"><kbd>3</kbd></span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Transactions tab</span>
                        <span class="settings-value"><kbd>4</kbd></span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Settings tab</span>
                        <span class="settings-value"><kbd>5</kbd></span>
                    </div>
                </div>
                <div class="settings-section">
                    <h3>About</h3>
                    <div class="settings-row">
                        <span class="settings-label">Version</span>
                        <span class="settings-value">1.0.0</span>
                    </div>
                    <div class="settings-row">
                        <span class="settings-label">Connection</span>
                        <span class="settings-value" id="ws-status-text">Connecting...</span>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="topology-tooltip" id="topology-tooltip" style="display:none"></div>
    <script>
        let ws = null;
        let mempoolChart = null;
        let mempoolSizeChart = null;
        let uaChart = null;
        let blocktimeChart = null;
        let txsizeChart = null;
        let feeDistChart = null;
        let feeHistoryChart = null;
        let qualityChart = null;
        let spamPieChart = null;
        let spamHistoryChart = null;
        let bandwidthChart = null;
        let msgTypeChart = null;
        let mempoolHistory = [];
        let mempoolSizeHistory = [];
        let feeHistory = [];
        let spamHistory = [];
        let bandwidthHistory = [];
        const maxHistory = 60;
        let nodeSort = 'default';
        let lastNodeList = [];
        let peerMap = null;
        let peerMarkers = {};
        const geoCache = {};
        const geoFailed = {};
        const uaColors = ['#e94560','#4ecca3','#ffc107','#00d9ff','#a855f7','#f97316','#22c55e','#3b82f6'];
        let lastTxs = [];
        const expandedTxids = new Set();
        const geoQueue = [];
        let geoProcessing = false;
        let lastData = null;
        let lastBlockHash = null;
        let blockTimeHistory = [];
        const maxBlockHistory = 20;
        let topologyVisible = false;
        let topologySvg = null;
        let topologySimulation = null;
        let lastTopology = null;
        let selectedTxPath = null;
        let currentTab = 'overview';
        const tabRendered = { overview: true, nodes: false, mempool: false, transactions: false, settings: false };

        function switchTab(tab) {
            if (currentTab === tab) return;
            document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-panel').forEach(panel => panel.classList.remove('active'));
            document.querySelector(`[data-tab="${tab}"]`).classList.add('active');
            document.getElementById(`tab-${tab}`).classList.add('active');
            currentTab = tab;
            localStorage.setItem('lastTab', tab);
            history.pushState(null, '', `#${tab}`);
            if (!tabRendered[tab] && lastData) {
                renderTabContent(tab);
                tabRendered[tab] = true;
            }
        }

        function renderTabContent(tab) {
            if (tab === 'nodes' && lastData) {
                renderNodeListDetail(lastData.node_list || []);
            } else if (tab === 'transactions' && lastData) {
                renderTxListDetail(true);
            }
        }

        function initTabs() {
            const hash = window.location.hash.slice(1);
            const saved = localStorage.getItem('lastTab');
            const validTabs = ['overview', 'nodes', 'mempool', 'transactions', 'settings'];
            let tab = 'overview';
            if (hash && validTabs.includes(hash)) tab = hash;
            else if (saved && validTabs.includes(saved)) tab = saved;
            if (tab !== 'overview') switchTab(tab);
        }

        window.addEventListener('hashchange', () => {
            const hash = window.location.hash.slice(1);
            const validTabs = ['overview', 'nodes', 'mempool', 'transactions', 'settings'];
            if (hash && validTabs.includes(hash) && hash !== currentTab) {
                switchTab(hash);
            }
        });

        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                openSearchModal();
                return;
            }
            if (e.key === '/' && e.target.tagName !== 'INPUT' && e.target.tagName !== 'TEXTAREA') {
                e.preventDefault();
                openSearchModal();
                return;
            }
            if (e.key === 'Escape') {
                if (document.getElementById('search-modal-overlay').classList.contains('show')) {
                    closeSearchModal();
                    return;
                }
                if (document.getElementById('settings-modal-overlay').classList.contains('show')) {
                    closeSettingsModal();
                    return;
                }
            }
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
            const tabKeys = { '1': 'overview', '2': 'nodes', '3': 'mempool', '4': 'transactions', '5': 'settings' };
            if (tabKeys[e.key]) {
                e.preventDefault();
                switchTab(tabKeys[e.key]);
            }
        });

        function updateDetailPanels(data) {
            const setEl = (id, val) => { const el = document.getElementById(id); if (el) el.textContent = val; };
            if (data.mempool) {
                setEl('mempool-count-detail', data.mempool.count.toLocaleString());
                if (data.mempool.vbytes !== undefined) setEl('mempool-size-detail', (data.mempool.vbytes / 1000000).toFixed(2) + ' vMB');
                if (data.mempool.memory_estimate !== undefined) setEl('mempool-memory-detail', (data.mempool.memory_estimate / 1000000).toFixed(1) + ' MB');
            }
            if (data.fee_stats) {
                setEl('median-fee-detail', data.fee_stats.median !== undefined ? data.fee_stats.median.toFixed(1) : '-');
                setEl('avg-fee-detail', data.fee_stats.avg !== undefined ? data.fee_stats.avg.toFixed(1) : '-');
                setEl('min-fee-detail', data.fee_stats.min !== undefined ? data.fee_stats.min.toFixed(1) : '-');
                setEl('max-fee-detail', data.fee_stats.max !== undefined ? data.fee_stats.max.toFixed(1) : '-');
            }
            const themeBtn = document.getElementById('theme-btn-settings');
            if (themeBtn) {
                const isLight = document.documentElement.getAttribute('data-theme') === 'light';
                themeBtn.textContent = isLight ? 'Dark' : 'Light';
            }
        }

        const MAX_SEARCH_HISTORY = 10;
        let searchHistory = JSON.parse(localStorage.getItem('searchHistory') || '[]');

        function openSearchModal() {
            document.getElementById('search-modal-overlay').classList.add('show');
            const input = document.getElementById('search-modal-input');
            input.value = '';
            input.focus();
            renderSearchResults('');
        }

        function closeSearchModal() {
            document.getElementById('search-modal-overlay').classList.remove('show');
        }

        function addToSearchHistory(query, type) {
            const entry = { query, type, time: Date.now() };
            searchHistory = searchHistory.filter(h => h.query !== query);
            searchHistory.unshift(entry);
            if (searchHistory.length > MAX_SEARCH_HISTORY) searchHistory.pop();
            localStorage.setItem('searchHistory', JSON.stringify(searchHistory));
        }

        function clearSearchHistory() {
            searchHistory = [];
            localStorage.removeItem('searchHistory');
            renderSearchResults('');
        }

        function isValidHex(str) {
            return /^[a-fA-F0-9]+$/.test(str);
        }

        function searchTransactions(query) {
            if (!lastTxs || !query) return [];
            const q = query.toLowerCase();
            return lastTxs.filter(tx => tx.txid.toLowerCase().startsWith(q)).slice(0, 10);
        }

        function searchBlock(query) {
            if (!lastData || !lastData.block || !query) return null;
            const q = query.toLowerCase();
            if (lastData.block.hash && lastData.block.hash.toLowerCase() === q) return lastData.block;
            if (lastData.block.hash && lastData.block.hash.toLowerCase().startsWith(q) && q.length >= 8) return lastData.block;
            return null;
        }

        function renderSearchResults(query) {
            const body = document.getElementById('search-modal-body');
            const q = query.trim();
            if (!q) {
                if (searchHistory.length === 0) {
                    body.innerHTML = '<div class="search-empty">Type to search transactions or blocks</div>';
                } else {
                    body.innerHTML = `
                        <div class="search-section">
                            <div class="search-history-item">
                                <span class="search-section-title">Recent Searches</span>
                                <span class="search-history-clear" onclick="clearSearchHistory()">Clear</span>
                            </div>
                            ${searchHistory.map(h => `
                                <div class="search-result" onclick="selectSearchResult('${esc(h.query)}','${h.type}')">
                                    <div class="search-result-type">${h.type}</div>
                                    <div class="search-result-value">${esc(h.query.length > 32 ? h.query.slice(0,16) + '...' + h.query.slice(-16) : h.query)}</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                return;
            }
            if (!isValidHex(q)) {
                body.innerHTML = '<div class="search-empty">Enter a valid hex string (txid or block hash)</div>';
                return;
            }
            let html = '';
            const txResults = searchTransactions(q);
            const blockResult = searchBlock(q);
            if (q.length === 64) {
                const exactTx = lastTxs ? lastTxs.find(tx => tx.txid.toLowerCase() === q.toLowerCase()) : null;
                if (exactTx) {
                    html += `
                        <div class="search-section">
                            <div class="search-section-title">Exact Match</div>
                            <div class="search-result" onclick="selectSearchResult('${exactTx.txid}','transaction')">
                                <div class="search-result-type">Transaction</div>
                                <div class="search-result-value">${exactTx.txid.slice(0,16)}...${exactTx.txid.slice(-16)}</div>
                                <div class="search-result-meta">${exactTx.size || '?'}B  ${exactTx.fee_rate ? exactTx.fee_rate.toFixed(1) + ' sat/vB' : 'fee unknown'}  ${exactTx.sources} peer(s)</div>
                            </div>
                        </div>
                    `;
                } else if (blockResult && blockResult.hash.toLowerCase() === q.toLowerCase()) {
                    html += `
                        <div class="search-section">
                            <div class="search-section-title">Exact Match</div>
                            <div class="search-result" onclick="selectSearchResult('${blockResult.hash}','block')">
                                <div class="search-result-type">Block</div>
                                <div class="search-result-value">${blockResult.hash.slice(0,16)}...${blockResult.hash.slice(-16)}</div>
                                <div class="search-result-meta">Height: ${blockResult.height || '?'}  ${blockResult.time ? new Date(blockResult.time * 1000).toLocaleString() : ''}</div>
                            </div>
                        </div>
                    `;
                } else {
                    html += '<div class="search-empty">No exact match found for this hash</div>';
                }
            } else {
                if (blockResult) {
                    html += `
                        <div class="search-section">
                            <div class="search-section-title">Block</div>
                            <div class="search-result" onclick="selectSearchResult('${blockResult.hash}','block')">
                                <div class="search-result-type">Block</div>
                                <div class="search-result-value">${blockResult.hash.slice(0,16)}...${blockResult.hash.slice(-16)}</div>
                                <div class="search-result-meta">Height: ${blockResult.height || '?'}  ${blockResult.time ? new Date(blockResult.time * 1000).toLocaleString() : ''}</div>
                            </div>
                        </div>
                    `;
                }
                if (txResults.length > 0) {
                    html += `
                        <div class="search-section">
                            <div class="search-section-title">Transactions (${txResults.length}${txResults.length === 10 ? '+' : ''})</div>
                            ${txResults.map(tx => `
                                <div class="search-result" onclick="selectSearchResult('${tx.txid}','transaction')">
                                    <div class="search-result-type">Transaction</div>
                                    <div class="search-result-value">${tx.txid.slice(0,16)}...${tx.txid.slice(-16)}</div>
                                    <div class="search-result-meta">${tx.size || '?'}B  ${tx.fee_rate ? tx.fee_rate.toFixed(1) + ' sat/vB' : 'fee unknown'}  ${tx.sources} peer(s)</div>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                if (!html) {
                    html = '<div class="search-empty">No results found</div>';
                }
            }
            body.innerHTML = html;
        }

        function selectSearchResult(value, type) {
            addToSearchHistory(value, type);
            closeSearchModal();
            if (type === 'transaction') {
                switchTab('transactions');
                setTimeout(() => {
                    const input = document.getElementById('tx-search-detail');
                    if (input) {
                        input.value = value.slice(0, 8);
                        renderTxListDetail(true);
                    }
                }, 100);
            } else if (type === 'block') {
                showToast(`Block ${value.slice(0,8)}... - Height: ${lastData?.block?.height || '?'}`, 'success');
            }
        }

        document.getElementById('search-modal-input').addEventListener('input', (e) => {
            renderSearchResults(e.target.value);
        });

        const defaultSettings = {
            theme: 'dark',
            compact: false,
            animations: true,
            refresh: '2000',
            maxTxs: '50',
            geoApi: 'ip-api',
            audio: false
        };
        let appSettings = { ...defaultSettings };

        function loadSettings() {
            const saved = localStorage.getItem('appSettings');
            if (saved) {
                try {
                    appSettings = { ...defaultSettings, ...JSON.parse(saved) };
                } catch (e) {
                    appSettings = { ...defaultSettings };
                }
            }
            applyAllSettings();
        }

        function saveSettings() {
            localStorage.setItem('appSettings', JSON.stringify(appSettings));
        }

        function applyAllSettings() {
            if (appSettings.theme === 'light') {
                document.documentElement.setAttribute('data-theme', 'light');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            document.body.classList.toggle('compact', appSettings.compact);
            updateSettingsUI();
        }

        function updateSettingsUI() {
            const themeSelect = document.getElementById('setting-theme');
            if (themeSelect) themeSelect.value = appSettings.theme;
            const compactToggle = document.getElementById('setting-compact');
            if (compactToggle) compactToggle.classList.toggle('active', appSettings.compact);
            const animToggle = document.getElementById('setting-animations');
            if (animToggle) animToggle.classList.toggle('active', appSettings.animations);
            const refreshSelect = document.getElementById('setting-refresh');
            if (refreshSelect) refreshSelect.value = appSettings.refresh;
            const maxTxsSelect = document.getElementById('setting-maxTxs');
            if (maxTxsSelect) maxTxsSelect.value = appSettings.maxTxs;
            const geoSelect = document.getElementById('setting-geoApi');
            if (geoSelect) geoSelect.value = appSettings.geoApi;
            const audioToggle = document.getElementById('setting-audio');
            if (audioToggle) audioToggle.classList.toggle('active', appSettings.audio);
        }

        function openSettingsModal() {
            updateSettingsUI();
            const stateSection = document.getElementById('state-section');
            if (stateSection && window.DASHBOARD_CONFIG && window.DASHBOARD_CONFIG.hasStateFile) {
                stateSection.style.display = 'block';
            }
            document.getElementById('settings-modal-overlay').classList.add('show');
        }

        function closeSettingsModal() {
            document.getElementById('settings-modal-overlay').classList.remove('show');
        }

        function applySetting(key, value) {
            appSettings[key] = value;
            saveSettings();
            if (key === 'theme') {
                if (value === 'light') {
                    document.documentElement.setAttribute('data-theme', 'light');
                } else {
                    document.documentElement.removeAttribute('data-theme');
                }
                updateThemeBtn();
                updateChartColors();
            } else if (key === 'compact') {
                document.body.classList.toggle('compact', value);
            } else if (key === 'animations') {
                updateChartAnimations();
            } else if (key === 'maxTxs') {
                renderTxList();
                if (currentTab === 'transactions') renderTxListDetail(true);
            }
        }

        function toggleSetting(key) {
            appSettings[key] = !appSettings[key];
            saveSettings();
            applySetting(key, appSettings[key]);
            updateSettingsUI();
        }

        function resetSettings() {
            appSettings = { ...defaultSettings };
            saveSettings();
            applyAllSettings();
            updateThemeBtn();
            updateChartColors();
            showToast('Settings reset to defaults', 'success');
        }

        function clearState() {
            if (!confirm('Clear all persistent state? This will delete saved peers, bans, block history, and statistics.')) return;
            fetch('/api/state/clear', { method: 'POST' })
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        showToast('State cleared successfully', 'success');
                    } else {
                        showToast('Failed to clear state', 'error');
                    }
                })
                .catch(() => showToast('Failed to clear state', 'error'));
        }

        function updateChartAnimations() {
            const duration = appSettings.animations ? 300 : 0;
            [mempoolChart, mempoolSizeChart, blocktimeChart, txsizeChart, feeDistChart, feeHistoryChart, qualityChart, spamPieChart, spamHistoryChart].forEach(chart => {
                if (chart && chart.options) {
                    chart.options.animation = { duration };
                }
            });
        }

        function getGeoApiUrl(ip) {
            if (appSettings.geoApi === 'none') return null;
            if (appSettings.geoApi === 'ipinfo') return `https://ipinfo.io/${ip}/json`;
            return `https://ip-api.com/json/${ip}`;
        }

        function initTheme() {
            loadSettings();
            updateThemeBtn();
            setTimeout(updateChartColors, 100);
        }

        function toggleTheme() {
            const newTheme = appSettings.theme === 'light' ? 'dark' : 'light';
            applySetting('theme', newTheme);
            updateSettingsUI();
        }

        function getChartColors() {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            return {
                text: isLight ? '#666' : '#888',
                grid: isLight ? 'rgba(0,0,0,0.1)' : 'rgba(255,255,255,0.1)',
                legend: isLight ? '#333' : '#eee'
            };
        }

        function updateChartColors() {
            const c = getChartColors();
            if (mempoolChart) {
                mempoolChart.options.scales.y.ticks.color = c.text;
                mempoolChart.options.scales.y.grid.color = c.grid;
                mempoolChart.update('none');
            }
            if (mempoolSizeChart) {
                mempoolSizeChart.options.scales.y.ticks.color = c.text;
                mempoolSizeChart.options.scales.y.grid.color = c.grid;
                mempoolSizeChart.update('none');
            }
            if (blocktimeChart) {
                blocktimeChart.options.scales.y.ticks.color = c.text;
                blocktimeChart.options.scales.y.title.color = c.text;
                blocktimeChart.options.scales.y.grid.color = c.grid;
                blocktimeChart.options.scales.x.ticks.color = c.text;
                blocktimeChart.options.scales.x.title.color = c.text;
                blocktimeChart.update('none');
            }
            if (txsizeChart) {
                txsizeChart.options.scales.y.ticks.color = c.text;
                txsizeChart.options.scales.y.title.color = c.text;
                txsizeChart.options.scales.y.grid.color = c.grid;
                txsizeChart.options.scales.x.ticks.color = c.text;
                txsizeChart.options.scales.x.title.color = c.text;
                txsizeChart.update('none');
            }
            if (feeDistChart) {
                feeDistChart.options.scales.y.ticks.color = c.text;
                feeDistChart.options.scales.y.grid.color = c.grid;
                feeDistChart.options.scales.x.ticks.color = c.text;
                feeDistChart.options.scales.x.title.color = c.text;
                feeDistChart.update('none');
            }
            if (feeHistoryChart) {
                feeHistoryChart.options.scales.y.ticks.color = c.text;
                feeHistoryChart.options.scales.y.grid.color = c.grid;
                feeHistoryChart.update('none');
            }
            if (qualityChart) {
                qualityChart.options.scales.x.ticks.color = c.text;
                qualityChart.options.scales.x.grid.color = c.grid;
                qualityChart.options.scales.y.ticks.color = c.text;
                qualityChart.update('none');
            }
            if (uaChart) {
                uaChart.options.plugins.legend.labels.color = c.legend;
                uaChart.update('none');
            }
        }

        function updateThemeBtn() {
            const isLight = document.documentElement.getAttribute('data-theme') === 'light';
            document.getElementById('theme-btn').textContent = isLight ? 'Dark' : 'Light';
        }

        function exportNodes(format) {
            if (!lastData || !lastData.node_list) return;
            const nodes = lastData.node_list;
            if (format === 'json') {
                downloadFile('nodes.json', JSON.stringify(nodes, null, 2), 'application/json');
            } else {
                const csv = 'index,addr,state,latency,bytes_in,bytes_out,msgs_in,msgs_out\n' +
                    nodes.map(n => `${n.index},${n.addr},${n.state},${n.latency||''},${n.bytes_in||0},${n.bytes_out||0},${n.msgs_in||0},${n.msgs_out||0}`).join('\n');
                downloadFile('nodes.csv', csv, 'text/csv');
            }
        }

        function exportTxs(format) {
            if (!lastData || !lastData.recent_txs) return;
            const txs = lastData.recent_txs;
            if (format === 'json') {
                downloadFile('transactions.json', JSON.stringify(txs, null, 2), 'application/json');
            }
        }

        function downloadFile(filename, content, type) {
            const blob = new Blob([content], { type });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            URL.revokeObjectURL(url);
        }

        function showBlockNotification() {
            const badge = document.getElementById('block-badge');
            badge.classList.add('show');
            playNotificationSound();
            setTimeout(() => badge.classList.remove('show'), 3000);
        }

        function playNotificationSound() {
            if (!appSettings.audio) return;
            try {
                const ctx = new (window.AudioContext || window.webkitAudioContext)();
                const osc = ctx.createOscillator();
                const gain = ctx.createGain();
                osc.connect(gain);
                gain.connect(ctx.destination);
                osc.frequency.value = 800;
                gain.gain.value = 0.1;
                osc.start();
                gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.2);
                osc.stop(ctx.currentTime + 0.2);
            } catch (e) {}
        }

        function initMap() {
            peerMap = L.map('peer-map', { attributionControl: false }).setView([20, 0], 2);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                maxZoom: 19
            }).addTo(peerMap);
            setTimeout(() => peerMap.invalidateSize(), 100);
        }

        function extractIp(addr) {
            if (!addr) return null;
            const match = addr.match(/^\[?([^\]:\s]+)\]?:/);
            return match ? match[1] : addr.split(':')[0];
        }

        function isPrivateIp(ip) {
            if (ip.startsWith('127.') || ip.startsWith('10.') || ip.startsWith('192.168.')) return true;
            if (ip.startsWith('172.')) {
                const second = parseInt(ip.split('.')[1], 10);
                if (second >= 16 && second <= 31) return true;
            }
            if (ip === '::1' || ip.startsWith('fe80:') || ip.startsWith('fc') || ip.startsWith('fd')) return true;
            return false;
        }

        function processGeoQueue() {
            if (geoProcessing || geoQueue.length === 0) return;
            if (appSettings.geoApi === 'none') { geoQueue.length = 0; return; }
            geoProcessing = true;
            const ip = geoQueue.shift();
            const url = appSettings.geoApi === 'ipinfo'
                ? `https://ipinfo.io/${ip}/json`
                : `https://ip-api.com/json/${ip}?fields=status,lat,lon,country,city`;
            fetch(url)
                .then(r => r.json())
                .then(d => {
                    if (appSettings.geoApi === 'ipinfo') {
                        if (d.loc) {
                            const [lat, lon] = d.loc.split(',').map(Number);
                            geoCache[ip] = { lat, lon, country: d.country, city: d.city };
                            addMarkerForIp(ip);
                        } else { geoFailed[ip] = true; }
                    } else {
                        if (d.status === 'success') {
                            geoCache[ip] = { lat: d.lat, lon: d.lon, country: d.country, city: d.city };
                            addMarkerForIp(ip);
                        } else { geoFailed[ip] = true; }
                    }
                })
                .catch(() => { geoFailed[ip] = true; })
                .finally(() => {
                    geoProcessing = false;
                    setTimeout(processGeoQueue, 1500);
                });
        }

        function addMarkerForIp(ip) {
            if (peerMarkers[ip] || !geoCache[ip]) return;
            const geo = geoCache[ip];
            const marker = L.circleMarker([geo.lat, geo.lon], {
                radius: 6, fillColor: '#4ecca3', fillOpacity: 0.8, color: '#fff', weight: 1
            }).addTo(peerMap);
            marker.bindPopup(esc(ip) + '<br>' + esc(geo.city || '') + ', ' + esc(geo.country || ''));
            peerMarkers[ip] = marker;
        }

        function queueGeoLookup(ip) {
            if (geoCache[ip] || geoFailed[ip] || isPrivateIp(ip) || geoQueue.includes(ip)) return;
            geoQueue.push(ip);
            processGeoQueue();
        }

        function updateMap(nodes) {
            const seen = new Set();
            for (const node of nodes) {
                if (node.state !== 'connected') continue;
                const ip = extractIp(node.addr);
                if (!ip) continue;
                seen.add(ip);
                if (peerMarkers[ip]) continue;
                if (geoCache[ip]) {
                    addMarkerForIp(ip);
                } else {
                    queueGeoLookup(ip);
                }
            }
            for (const ip of Object.keys(peerMarkers)) {
                if (!seen.has(ip)) {
                    peerMap.removeLayer(peerMarkers[ip]);
                    delete peerMarkers[ip];
                }
            }
        }

        function initChart() {
            const ctx = document.getElementById('mempool-chart').getContext('2d');
            mempoolChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Tx Count',
                        data: [],
                        borderColor: '#e94560',
                        backgroundColor: 'rgba(233, 69, 96, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
            const sizeCtx = document.getElementById('mempool-size-chart').getContext('2d');
            mempoolSizeChart = new Chart(sizeCtx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [{
                        label: 'Size (MB)',
                        data: [],
                        borderColor: '#4ecca3',
                        backgroundColor: 'rgba(78, 204, 163, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: {
                            beginAtZero: true,
                            ticks: { color: '#888' },
                            grid: { color: 'rgba(255,255,255,0.1)' }
                        }
                    }
                }
            });
        }

        function updateChart(count, sizeVbytes) {
            const now = new Date();
            const sizeMB = (sizeVbytes || 0) / 1048576;
            mempoolHistory.push({ time: now, count: count });
            if (mempoolHistory.length > maxHistory) mempoolHistory.shift();
            mempoolChart.data.labels = mempoolHistory.map(h =>
                h.time.toLocaleTimeString([], {minute: '2-digit', second: '2-digit'})
            );
            mempoolChart.data.datasets[0].data = mempoolHistory.map(h => h.count);
            mempoolChart.update('none');
            mempoolSizeHistory.push({ time: now, size: sizeMB });
            if (mempoolSizeHistory.length > maxHistory) mempoolSizeHistory.shift();
            mempoolSizeChart.data.labels = mempoolSizeHistory.map(h =>
                h.time.toLocaleTimeString([], {minute: '2-digit', second: '2-digit'})
            );
            mempoolSizeChart.data.datasets[0].data = mempoolSizeHistory.map(h => h.size);
            mempoolSizeChart.update('none');
        }

        const uaLabelPlugin = {
            id: 'uaLabels',
            afterDraw(chart) {
                const { ctx, data } = chart;
                const dataset = data.datasets[0];
                const total = dataset.data.reduce((a, b) => a + b, 0);
                if (total === 0) return;
                chart.getDatasetMeta(0).data.forEach((arc, i) => {
                    const value = dataset.data[i];
                    const pct = ((value / total) * 100).toFixed(0);
                    if (pct < 5) return;
                    const { x, y } = arc.tooltipPosition();
                    ctx.save();
                    ctx.fillStyle = '#222';
                    ctx.font = 'bold 11px sans-serif';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    ctx.fillText(`${pct}%`, x, y);
                    ctx.restore();
                });
            }
        };

        function initUaChart() {
            const ctx = document.getElementById('ua-chart').getContext('2d');
            uaChart = new Chart(ctx, {
                type: 'doughnut',
                data: { labels: [], datasets: [{ data: [], backgroundColor: uaColors }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'right',
                            labels: {
                                color: '#eee',
                                boxWidth: 12,
                                font: { size: 10 },
                                generateLabels: function(chart) {
                                    const data = chart.data;
                                    const total = data.datasets[0].data.reduce((a, b) => a + b, 0);
                                    return data.labels.map((label, i) => {
                                        const value = data.datasets[0].data[i];
                                        const pct = total > 0 ? ((value / total) * 100).toFixed(0) : 0;
                                        return {
                                            text: `${label} (${value}, ${pct}%)`,
                                            fillStyle: data.datasets[0].backgroundColor[i],
                                            fontColor: getChartColors().legend,
                                            hidden: false,
                                            index: i
                                        };
                                    });
                                }
                            }
                        }
                    }
                },
                plugins: [uaLabelPlugin]
            });
        }

        function updateUaChart(userAgents) {
            const entries = Object.entries(userAgents || {}).sort((a, b) => b[1] - a[1]).slice(0, 8);
            uaChart.data.labels = entries.map(e => e[0].replace(/^\/|\/$|Satoshi:/g, '').slice(0, 16));
            uaChart.data.datasets[0].data = entries.map(e => e[1]);
            uaChart.update('none');
        }

        function initBlocktimeChart() {
            const ctx = document.getElementById('blocktime-chart').getContext('2d');
            blocktimeChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: [], datasets: [{ label: 'Minutes', data: [], backgroundColor: '#4ecca3' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Minutes', color: '#888' }, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { title: { display: true, text: 'Block #', color: '#888' }, ticks: { color: '#888' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateBlocktimeChart(blockData) {
            if (!blockData || !blockData.time) return;
            const now = Date.now();
            if (lastBlockHash && blockData.hash !== lastBlockHash) {
                const lastEntry = blockTimeHistory[blockTimeHistory.length - 1];
                if (lastEntry) {
                    const interval = (now - lastEntry.arrived) / 60000;
                    blockTimeHistory.push({ block: blockData.seen, interval, arrived: now });
                } else {
                    blockTimeHistory.push({ block: blockData.seen, interval: 0, arrived: now });
                }
                if (blockTimeHistory.length > maxBlockHistory) blockTimeHistory.shift();
                blocktimeChart.data.labels = blockTimeHistory.map(b => b.block);
                blocktimeChart.data.datasets[0].data = blockTimeHistory.map(b => b.interval.toFixed(1));
                blocktimeChart.update('none');
            } else if (blockTimeHistory.length === 0 && blockData.hash) {
                blockTimeHistory.push({ block: blockData.seen, interval: 0, arrived: now });
            }
        }

        function initTxsizeChart() {
            const ctx = document.getElementById('txsize-chart').getContext('2d');
            txsizeChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['<250', '250-500', '500-1K', '1K-2K', '2K-5K', '>5K'], datasets: [{ label: 'Transactions', data: [0,0,0,0,0,0], backgroundColor: '#e94560' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, title: { display: true, text: 'Count', color: '#888' }, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { title: { display: true, text: 'Size (bytes)', color: '#888' }, ticks: { color: '#888' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateTxsizeChart(txs) {
            if (!txs || txs.length === 0) return;
            const buckets = [0, 0, 0, 0, 0, 0];
            for (const tx of txs) {
                if (!tx.size) continue;
                if (tx.size < 250) buckets[0]++;
                else if (tx.size < 500) buckets[1]++;
                else if (tx.size < 1000) buckets[2]++;
                else if (tx.size < 2000) buckets[3]++;
                else if (tx.size < 5000) buckets[4]++;
                else buckets[5]++;
            }
            txsizeChart.data.datasets[0].data = buckets;
            txsizeChart.update('none');
        }

        function initFeeCharts() {
            const ctx1 = document.getElementById('fee-dist-chart').getContext('2d');
            feeDistChart = new Chart(ctx1, {
                type: 'bar',
                data: { labels: ['1-5', '5-10', '10-25', '25-50', '50-100', '100+'], datasets: [{ label: 'Transactions', data: [0,0,0,0,0,0], backgroundColor: '#4ecca3' }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        x: { title: { display: true, text: 'sat/vB', color: '#888' }, ticks: { color: '#888' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
            const ctx2 = document.getElementById('fee-history-chart').getContext('2d');
            feeHistoryChart = new Chart(ctx2, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Median Fee', data: [], borderColor: '#4ecca3', backgroundColor: 'rgba(78, 204, 163, 0.1)', fill: true, tension: 0.4 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { display: false } },
                    scales: {
                        x: { display: false },
                        y: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        function updateFeeCharts(feeStats) {
            if (!feeStats) return;
            document.getElementById('median-fee').textContent = feeStats.median !== null ? feeStats.median.toFixed(1) : '-';
            document.getElementById('fee-tx-count').textContent = feeStats.count;
            if (feeStats.buckets) {
                feeDistChart.data.datasets[0].data = feeStats.buckets;
                feeDistChart.update('none');
            }
            if (feeStats.median !== null) {
                const now = new Date();
                feeHistory.push({ time: now, median: feeStats.median });
                if (feeHistory.length > maxHistory) feeHistory.shift();
                feeHistoryChart.data.labels = feeHistory.map(h => h.time.toLocaleTimeString([], {minute: '2-digit', second: '2-digit'}));
                feeHistoryChart.data.datasets[0].data = feeHistory.map(h => h.median);
                feeHistoryChart.update('none');
            }
        }

        function initQualityChart() {
            const ctx = document.getElementById('quality-chart').getContext('2d');
            qualityChart = new Chart(ctx, {
                type: 'bar',
                data: { labels: ['Excellent', 'Good', 'Fair', 'Poor'], datasets: [{ data: [0,0,0,0], backgroundColor: ['#4ecca3','#a3e048','#ffc107','#e94560'] }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    scales: {
                        x: { beginAtZero: true, ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } },
                        y: { ticks: { color: '#888' }, grid: { display: false } }
                    },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateQualityChart(peerQuality) {
            if (!peerQuality) return;
            document.getElementById('avg-quality').textContent = peerQuality.avg;
            document.getElementById('quality-count').textContent = peerQuality.count;
            if (peerQuality.dist) {
                qualityChart.data.datasets[0].data = peerQuality.dist;
                qualityChart.update('none');
            }
        }

        function initSpamCharts() {
            const pieCtx = document.getElementById('spam-pie-chart').getContext('2d');
            spamPieChart = new Chart(pieCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Regular', 'Spam'],
                    datasets: [{ data: [100, 0], backgroundColor: ['#4ecca3', '#ffc107'], borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'bottom', labels: { color: '#888', boxWidth: 12 } } }
                }
            });
            const histCtx = document.getElementById('spam-history-chart').getContext('2d');
            spamHistoryChart = new Chart(histCtx, {
                type: 'line',
                data: { labels: [], datasets: [{ label: 'Spam %', data: [], borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.1)', fill: true, tension: 0.3 }] },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { min: 0, max: 100, ticks: { color: '#888' } } },
                    plugins: { legend: { display: false } }
                }
            });
        }

        function updateSpamCharts(spamStats) {
            if (!spamStats) return;
            document.getElementById('spam-pct').textContent = spamStats.spam_pct.toFixed(1) + '%';
            document.getElementById('spam-count').textContent = spamStats.spam_count;
            if (spamPieChart) {
                spamPieChart.data.datasets[0].data = [spamStats.regular_count, spamStats.spam_count];
                spamPieChart.update('none');
            }
            spamHistory.push(spamStats.spam_pct);
            if (spamHistory.length > maxHistory) spamHistory.shift();
            if (spamHistoryChart) {
                spamHistoryChart.data.labels = spamHistory.map((_, i) => i);
                spamHistoryChart.data.datasets[0].data = spamHistory;
                spamHistoryChart.update('none');
            }
        }

        function initBandwidthChart() {
            const ctx = document.getElementById('bandwidth-chart').getContext('2d');
            bandwidthChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: [],
                    datasets: [
                        { label: 'In', data: [], borderColor: '#4ecca3', backgroundColor: 'rgba(78,204,163,0.1)', fill: true, tension: 0.3 },
                        { label: 'Out', data: [], borderColor: '#ffc107', backgroundColor: 'rgba(255,193,7,0.1)', fill: true, tension: 0.3 }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: { x: { display: false }, y: { ticks: { color: '#888' }, grid: { color: 'rgba(255,255,255,0.1)' } } },
                    plugins: { legend: { display: true, position: 'bottom', labels: { color: '#888', boxWidth: 12 } } }
                }
            });
        }

        function initMsgTypeChart() {
            const ctx = document.getElementById('msg-type-chart').getContext('2d');
            msgTypeChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: [],
                    datasets: [{ data: [], backgroundColor: uaColors, borderWidth: 0 }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: { legend: { position: 'right', labels: { color: '#888', boxWidth: 12, font: { size: 10 } } } }
                }
            });
        }

        function updateConnectionStats(stats) {
            if (!stats) return;
            const formatBytes = (b) => {
                if (b >= 1e9) return (b / 1e9).toFixed(2) + ' GB';
                if (b >= 1e6) return (b / 1e6).toFixed(2) + ' MB';
                if (b >= 1e3) return (b / 1e3).toFixed(1) + ' KB';
                return b + ' B';
            };
            document.getElementById('total-bandwidth-in').textContent = formatBytes(stats.bytes_in);
            document.getElementById('total-bandwidth-out').textContent = formatBytes(stats.bytes_out);
            document.getElementById('total-msgs').textContent = (stats.msgs_in + stats.msgs_out).toLocaleString();
            document.getElementById('avg-latency').textContent = stats.avg_latency > 0 ? stats.avg_latency + ' ms' : '- ms';
            const hours = Math.floor(stats.uptime / 3600);
            const mins = Math.floor((stats.uptime % 3600) / 60);
            document.getElementById('session-uptime').textContent = hours + 'h ' + mins + 'm';
            bandwidthHistory.push({ in: stats.bytes_in, out: stats.bytes_out });
            if (bandwidthHistory.length > maxHistory) bandwidthHistory.shift();
            if (bandwidthChart) {
                bandwidthChart.data.labels = bandwidthHistory.map((_, i) => i);
                bandwidthChart.data.datasets[0].data = bandwidthHistory.map(h => h.in / 1e6);
                bandwidthChart.data.datasets[1].data = bandwidthHistory.map(h => h.out / 1e6);
                bandwidthChart.update('none');
            }
        }

        function updateMsgTypes(msgTypes) {
            if (!msgTypes || !msgTypeChart) return;
            const entries = Object.entries(msgTypes).sort((a, b) => b[1] - a[1]).slice(0, 8);
            msgTypeChart.data.labels = entries.map(e => e[0]);
            msgTypeChart.data.datasets[0].data = entries.map(e => e[1]);
            msgTypeChart.update('none');
        }

        function toggleTopology() {
            topologyVisible = !topologyVisible;
            const card = document.getElementById('topology-card');
            const btn = document.getElementById('topology-btn');
            if (topologyVisible) {
                card.classList.remove('hidden');
                btn.classList.add('active');
                if (!topologySvg) initTopology();
                if (lastTopology) updateTopology(lastTopology);
            } else {
                card.classList.add('hidden');
                btn.classList.remove('active');
            }
        }

        function initTopology() {
            const container = document.getElementById('topology-graph');
            const width = container.clientWidth;
            const height = 400;
            topologySvg = d3.select('#topology-graph')
                .append('svg')
                .attr('width', width)
                .attr('height', height);
            topologySvg.append('g').attr('class', 'links');
            topologySvg.append('g').attr('class', 'nodes');
            topologySvg.append('g').attr('class', 'labels');
            topologySimulation = d3.forceSimulation()
                .force('link', d3.forceLink().id(d => d.id).distance(100))
                .force('charge', d3.forceManyBody().strength(-300))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(30));
        }

        function updateTopology(topology) {
            if (!topologySvg || !topology) return;
            lastTopology = topology;
            if (!topologyVisible) return;
            const container = document.getElementById('topology-graph');
            const width = container.clientWidth;
            const height = 400;
            const nodes = topology.nodes || [];
            const links = (topology.edges || []).map(e => ({...e}));
            const maxWeight = Math.max(1, ...links.map(l => l.weight));
            topologySimulation.nodes(nodes);
            topologySimulation.force('link').links(links);
            topologySimulation.force('center', d3.forceCenter(width / 2, height / 2));
            const link = topologySvg.select('.links')
                .selectAll('line')
                .data(links, d => d.source.id + '-' + d.target.id);
            link.exit().remove();
            const linkEnter = link.enter().append('line')
                .attr('class', 'topology-link')
                .attr('stroke-width', d => 1 + (d.weight / maxWeight) * 4);
            link.merge(linkEnter).attr('stroke-width', d => 1 + (d.weight / maxWeight) * 4);
            const node = topologySvg.select('.nodes')
                .selectAll('circle')
                .data(nodes, d => d.id);
            node.exit().remove();
            const nodeEnter = node.enter().append('circle')
                .attr('class', d => 'topology-node ' + d.type)
                .attr('r', d => d.type === 'self' ? 15 : 10)
                .call(d3.drag()
                    .on('start', dragstarted)
                    .on('drag', dragged)
                    .on('end', dragended))
                .on('mouseover', showTooltip)
                .on('mouseout', hideTooltip)
                .on('click', nodeClicked);
            node.merge(nodeEnter)
                .attr('class', d => {
                    let cls = 'topology-node ' + d.type;
                    if (selectedTxPath && selectedTxPath.peers.includes(parseInt(d.id))) cls += ' highlighted';
                    return cls;
                });
            const label = topologySvg.select('.labels')
                .selectAll('text')
                .data(nodes.filter(n => n.type === 'self'), d => d.id);
            label.exit().remove();
            label.enter().append('text')
                .attr('class', 'topology-label')
                .attr('text-anchor', 'middle')
                .attr('dy', 4)
                .text('You');
            topologySimulation.alpha(0.3).restart();
            topologySimulation.on('tick', () => {
                topologySvg.select('.links').selectAll('line')
                    .attr('x1', d => d.source.x)
                    .attr('y1', d => d.source.y)
                    .attr('x2', d => d.target.x)
                    .attr('y2', d => d.target.y);
                topologySvg.select('.nodes').selectAll('circle')
                    .attr('cx', d => d.x = Math.max(15, Math.min(width - 15, d.x)))
                    .attr('cy', d => d.y = Math.max(15, Math.min(height - 15, d.y)));
                topologySvg.select('.labels').selectAll('text')
                    .attr('x', d => d.x)
                    .attr('y', d => d.y);
            });
            updateTxPathList(topology.tx_sources || []);
        }

        function dragstarted(event, d) {
            if (!event.active) topologySimulation.alphaTarget(0.3).restart();
            d.fx = d.x;
            d.fy = d.y;
        }

        function dragged(event, d) {
            d.fx = event.x;
            d.fy = event.y;
        }

        function dragended(event, d) {
            if (!event.active) topologySimulation.alphaTarget(0);
            d.fx = null;
            d.fy = null;
        }

        function showTooltip(event, d) {
            const tooltip = document.getElementById('topology-tooltip');
            if (d.type === 'self') {
                tooltip.innerHTML = '<h4>Your Node</h4><p>Central hub</p>';
            } else {
                tooltip.innerHTML = `<h4>${esc(d.addr || 'Peer ' + d.id)}</h4>
                    <p>Messages: ${d.msgs || 0}</p>
                    ${d.latency ? '<p>Latency: ' + d.latency + 'ms</p>' : ''}
                    ${d.quality !== undefined ? '<p>Quality: ' + d.quality + '/100</p>' : ''}
                    ${d.ua ? '<p>UA: ' + esc(d.ua) + '</p>' : ''}`;
            }
            tooltip.style.display = 'block';
            tooltip.style.left = (event.pageX + 10) + 'px';
            tooltip.style.top = (event.pageY - 10) + 'px';
        }

        function hideTooltip() {
            document.getElementById('topology-tooltip').style.display = 'none';
        }

        function nodeClicked(event, d) {
            if (d.type === 'peer' && lastTopology && lastTopology.tx_sources) {
                const peerId = parseInt(d.id);
                const txsFromPeer = lastTopology.tx_sources.filter(tx => tx.peers.includes(peerId));
                if (txsFromPeer.length > 0) {
                    highlightTxPath({ txid: 'all-from-' + d.id, peers: [peerId] });
                }
            }
        }

        function updateTxPathList(txSources) {
            const list = document.getElementById('tx-path-list');
            if (txSources.length === 0) {
                list.innerHTML = '<div class="empty">No recent transactions</div>';
                return;
            }
            list.innerHTML = txSources.slice(0, 10).map(tx => `
                <div class="tx-path-item ${selectedTxPath && selectedTxPath.txid === tx.txid ? 'active' : ''}"
                     onclick="highlightTxPath({txid:'${tx.txid}',peers:[${tx.peers.join(',')}]})">
                    ${tx.txid.slice(0, 16)}... (${tx.peers.length} peer${tx.peers.length > 1 ? 's' : ''})
                </div>
            `).join('');
        }

        function highlightTxPath(tx) {
            if (selectedTxPath && selectedTxPath.txid === tx.txid) {
                selectedTxPath = null;
            } else {
                selectedTxPath = tx;
            }
            topologySvg.select('.nodes').selectAll('circle')
                .attr('class', d => {
                    let cls = 'topology-node ' + d.type;
                    if (selectedTxPath && selectedTxPath.peers.includes(parseInt(d.id))) cls += ' highlighted';
                    return cls;
                });
            topologySvg.select('.links').selectAll('line')
                .attr('class', d => {
                    let cls = 'topology-link';
                    if (selectedTxPath && selectedTxPath.peers.includes(parseInt(d.target.id))) cls += ' highlighted';
                    return cls;
                });
            updateTxPathList(lastTopology ? lastTopology.tx_sources || [] : []);
        }

        function setNodeSort(sort) {
            nodeSort = sort;
            document.querySelectorAll('.node-sort-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            renderNodeList();
        }

        function getQualityClass(score) {
            if (score >= 80) return 'excellent';
            if (score >= 60) return 'good';
            if (score >= 40) return 'fair';
            return 'poor';
        }

        function formatBytes(bytes) {
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1048576) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / 1048576).toFixed(1) + 'MB';
        }

        function formatRate(msgs, connectTime) {
            if (!connectTime) return '-';
            const secs = Math.max(1, Math.floor(Date.now() / 1000) - connectTime);
            const rate = msgs / secs;
            return rate < 1 ? rate.toFixed(2) : rate.toFixed(1);
        }

        function esc(s) {
            const d = document.createElement('div');
            d.textContent = s;
            return d.innerHTML;
        }

        function formatTimeSince(timestamp) {
            if (!timestamp) return '-';
            const seconds = Math.floor(Date.now() / 1000) - timestamp;
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            return Math.floor(seconds / 3600) + 'h ' + Math.floor((seconds % 3600) / 60) + 'm';
        }

        function updateUI(data) {
            document.getElementById('total-nodes').textContent = data.nodes.total;
            document.getElementById('connected-nodes').textContent = data.nodes.connected;
            document.getElementById('connecting-nodes').textContent = data.nodes.connecting;
            document.getElementById('failed-nodes').textContent = data.nodes.failed;
            document.getElementById('mempool-count').textContent = data.mempool.count;
            const sizeVMB = (data.mempool.size_vbytes || 0) / 1048576;
            const memMB = (data.mempool.memory || 0) / 1048576;
            document.getElementById('mempool-size').textContent = sizeVMB.toFixed(2) + ' MB';
            document.getElementById('mempool-memory').textContent = memMB.toFixed(2) + ' MB';
            updateChart(data.mempool.count, data.mempool.size_vbytes);

            if (data.sync_status) {
                const sync = data.sync_status;
                document.getElementById('sync-height').textContent = sync.height.toLocaleString();
                document.getElementById('sync-highest').textContent = sync.highest_peer.toLocaleString();
                document.getElementById('sync-bar-fill').style.width = sync.progress_pct + '%';
                const badge = document.getElementById('sync-badge');
                const info = document.getElementById('sync-info');
                if (sync.highest_peer === 0) {
                    badge.className = 'sync-badge syncing';
                    badge.textContent = 'Connecting...';
                    info.textContent = 'Waiting for peers...';
                } else if (sync.synced) {
                    badge.className = 'sync-badge synced';
                    badge.textContent = 'Synced';
                    info.textContent = 'Receiving blocks from network';
                } else {
                    badge.className = 'sync-badge syncing';
                    badge.textContent = sync.blocks_behind + ' behind';
                    info.textContent = sync.progress_pct.toFixed(1) + '% synced with network';
                }
            }

            document.getElementById('blocks-seen').textContent = data.block.seen;
            document.getElementById('time-since-block').textContent = formatTimeSince(data.block.time);
            document.getElementById('block-hash').textContent = data.block.hash || 'Waiting for block...';

            lastNodeList = data.node_list || [];
            renderNodeList();

            lastTxs = data.recent_txs || [];
            renderTxList();
        }

        function renderNodeList() {
            const nodeListEl = document.getElementById('node-list');
            if (lastNodeList.length === 0) {
                nodeListEl.innerHTML = '<div class="empty">No nodes connected yet</div>';
                return;
            }
            let sorted = [...lastNodeList];
            if (nodeSort === 'quality') sorted.sort((a, b) => (b.quality || 0) - (a.quality || 0));
            else if (nodeSort === 'latency') sorted.sort((a, b) => (a.latency || 9999) - (b.latency || 9999));
            else if (nodeSort === 'bandwidth') sorted.sort((a, b) => (b.bytes_in || 0) - (a.bytes_in || 0));

            nodeListEl.innerHTML = sorted.map(node => {
                const qClass = node.quality !== undefined ? getQualityClass(node.quality) : '';
                const qDot = qClass ? `<span class="quality-dot ${qClass}"></span>` : '';
                const tooltip = node.quality !== undefined ? `
                    <span class="quality-tooltip">${qDot}
                        <span class="tooltip-text">
                            Quality: ${node.quality}/100<br>
                            ${node.latency ? 'Latency: ' + node.latency + 'ms<br>' : ''}
                            ${node.handshake_ms ? 'Handshake: ' + node.handshake_ms + 'ms<br>' : ''}
                            Reconnects: ${node.reconnects || 0}
                        </span>
                    </span>` : '';
                const actions = node.state === 'connected' ? `
                    <div class="node-actions">
                        <button class="node-action-btn danger" onclick="event.stopPropagation();confirmDisconnect(${node.index},'${esc(node.addr)}')" title="Disconnect"></button>
                        <select class="ban-select" onchange="event.stopPropagation();if(this.value)confirmBan('${esc(node.addr)}',this.value);this.value=''" title="Ban peer">
                            <option value="">Ban...</option>
                            <option value="3600">1 hour</option>
                            <option value="86400">24 hours</option>
                            <option value="604800">7 days</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>` : '';
                return `
                <div class="node-item">
                    <div class="node-header">
                        <span class="node-addr">${tooltip}${esc(node.addr)}</span>
                        <span style="display:flex;align-items:center">
                            ${node.latency ? `<span class="node-latency">${esc(String(node.latency))}ms</span>` : ''}
                            <span class="node-status ${esc(node.state)}">${esc(node.state)}</span>
                            ${actions}
                        </span>
                    </div>
                    ${node.bytes_in !== undefined ? `<div class="node-bandwidth">
                        <span class="in">${formatBytes(node.bytes_in)}</span>
                        <span class="out">${formatBytes(node.bytes_out)}</span>
                        <span>${formatRate(node.msgs_in, node.connect_time)} msg/s</span>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function renderNodeListDetail(nodes) {
            const nodeListEl = document.getElementById('node-list-detail');
            if (!nodeListEl) return;
            if (!nodes || nodes.length === 0) {
                nodeListEl.innerHTML = '<div class="empty">No nodes connected yet</div>';
                return;
            }
            let sorted = [...nodes];
            if (nodeSort === 'quality') sorted.sort((a, b) => (b.quality || 0) - (a.quality || 0));
            else if (nodeSort === 'latency') sorted.sort((a, b) => (a.latency || 9999) - (b.latency || 9999));
            else if (nodeSort === 'bandwidth') sorted.sort((a, b) => (b.bytes_in || 0) - (a.bytes_in || 0));
            nodeListEl.innerHTML = sorted.map(node => {
                const qClass = node.quality !== undefined ? getQualityClass(node.quality) : '';
                const qDot = qClass ? `<span class="quality-dot ${qClass}"></span>` : '';
                const tooltip = node.quality !== undefined ? `
                    <span class="quality-tooltip">${qDot}
                        <span class="tooltip-text">
                            Quality: ${node.quality}/100<br>
                            ${node.latency ? 'Latency: ' + node.latency + 'ms<br>' : ''}
                            ${node.handshake_ms ? 'Handshake: ' + node.handshake_ms + 'ms<br>' : ''}
                            Reconnects: ${node.reconnects || 0}
                        </span>
                    </span>` : '';
                const actions = node.state === 'connected' ? `
                    <div class="node-actions">
                        <button class="node-action-btn danger" onclick="event.stopPropagation();confirmDisconnect(${node.index},'${esc(node.addr)}')" title="Disconnect"></button>
                        <select class="ban-select" onchange="event.stopPropagation();if(this.value)confirmBan('${esc(node.addr)}',this.value);this.value=''" title="Ban peer">
                            <option value="">Ban...</option>
                            <option value="3600">1 hour</option>
                            <option value="86400">24 hours</option>
                            <option value="604800">7 days</option>
                            <option value="0">Permanent</option>
                        </select>
                    </div>` : '';
                return `
                <div class="node-item">
                    <div class="node-header">
                        <span class="node-addr">${tooltip}${esc(node.addr)}</span>
                        <span style="display:flex;align-items:center">
                            ${node.latency ? `<span class="node-latency">${esc(String(node.latency))}ms</span>` : ''}
                            <span class="node-status ${esc(node.state)}">${esc(node.state)}</span>
                            ${actions}
                        </span>
                    </div>
                    ${node.bytes_in !== undefined ? `<div class="node-bandwidth">
                        <span class="in">${formatBytes(node.bytes_in)}</span>
                        <span class="out">${formatBytes(node.bytes_out)}</span>
                        <span>${formatRate(node.msgs_in, node.connect_time)} msg/s</span>
                    </div>` : ''}
                </div>`;
            }).join('');
        }

        function getFeeClass(feeRate) {
            if (feeRate === undefined || feeRate === null) return '';
            if (feeRate < 10) return 'fee-low';
            if (feeRate < 50) return 'fee-medium';
            return 'fee-high';
        }

        function copyToClipboard(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const orig = btn.textContent;
                btn.textContent = 'Copied!';
                setTimeout(() => btn.textContent = orig, 1000);
            });
        }

        let modalCallback = null;
        function showModal(title, message, onConfirm) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-message').textContent = message;
            modalCallback = onConfirm;
            document.getElementById('modal-overlay').classList.add('show');
        }
        function closeModal() {
            document.getElementById('modal-overlay').classList.remove('show');
            modalCallback = null;
        }
        document.getElementById('modal-confirm').onclick = () => {
            if (modalCallback) modalCallback();
            closeModal();
        };

        function showToast(message, type = 'success') {
            const container = document.getElementById('toast-container');
            const toast = document.createElement('div');
            toast.className = 'toast ' + type;
            toast.textContent = message;
            container.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        function confirmDisconnect(index, addr) {
            showModal('Disconnect Peer', `Disconnect from ${addr}?`, () => {
                fetch('/api/peer/disconnect', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ index })
                }).then(r => r.json()).then(data => {
                    if (data.success) showToast('Peer disconnected');
                    else showToast(data.error || 'Failed to disconnect', 'error');
                }).catch(() => showToast('Request failed', 'error'));
            });
        }

        function confirmBan(addr, duration) {
            const durText = duration === '0' ? 'permanently' : duration === '3600' ? 'for 1 hour' : duration === '86400' ? 'for 24 hours' : 'for 7 days';
            showModal('Ban Peer', `Ban ${addr} ${durText}?`, () => {
                fetch('/api/peer/ban', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ addr, duration: parseInt(duration) })
                }).then(r => r.json()).then(data => {
                    if (data.success) showToast('Peer banned');
                    else showToast(data.error || 'Failed to ban', 'error');
                }).catch(() => showToast('Request failed', 'error'));
            });
        }

        function unbanPeer(addr) {
            fetch('/api/peer/unban', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ addr })
            }).then(r => r.json()).then(data => {
                if (data.success) showToast('Peer unbanned');
                else showToast(data.error || 'Failed to unban', 'error');
            }).catch(() => showToast('Request failed', 'error'));
        }

        function formatDuration(seconds) {
            if (seconds < 0) return 'permanent';
            if (seconds < 60) return seconds + 's';
            if (seconds < 3600) return Math.floor(seconds / 60) + 'm';
            if (seconds < 86400) return Math.floor(seconds / 3600) + 'h';
            return Math.floor(seconds / 86400) + 'd';
        }

        function renderBannedList(banned) {
            const list = document.getElementById('banned-list');
            document.getElementById('banned-count').textContent = '(' + banned.length + ')';
            if (banned.length === 0) {
                list.innerHTML = '<div class="empty">No banned peers</div>';
                return;
            }
            list.innerHTML = banned.map(b => `
                <div class="banned-item">
                    <div>
                        <span class="banned-addr">${esc(b.addr)}</span>
                        <span class="banned-time">${b.remaining < 0 ? 'permanent' : formatDuration(b.remaining) + ' left'}</span>
                    </div>
                    <button class="node-action-btn" onclick="unbanPeer('${esc(b.addr)}')">Unban</button>
                </div>
            `).join('');
        }

        function toggleTxExpand(el, txid) {
            el.classList.toggle('expanded');
            if (el.classList.contains('expanded')) {
                expandedTxids.add(txid);
            } else {
                expandedTxids.delete(txid);
            }
        }

        function renderTxList() {
            const filter = document.getElementById('tx-search').value.toLowerCase();
            const hideSpam = document.getElementById('hide-spam').checked;
            let filtered = lastTxs.filter(tx => !filter || tx.txid.toLowerCase().startsWith(filter));
            if (hideSpam) filtered = filtered.filter(tx => (tx.spam_score || 0) < 30);
            const txList = document.getElementById('tx-list');
            if (filtered.length === 0) {
                txList.innerHTML = '<div class="empty">' + (filter || hideSpam ? 'No matching transactions' : 'No transactions yet') + '</div>';
            } else {
                txList.innerHTML = filtered.slice(0, parseInt(appSettings.maxTxs) || 20).map((tx, i) => {
                    const delays = tx.delays || [];
                    const propStr = delays.length > 0
                        ? delays.slice(0, 5).map(d => d + 's').join(', ') + (delays.length > 5 ? '...' : '')
                        : '-';
                    const feeClass = getFeeClass(tx.fee_rate);
                    const isSpam = (tx.spam_score || 0) >= 30;
                    const spamClass = isSpam ? ' spam' : '';
                    const spamIcon = isSpam ? getSpamIcon(tx) : '';
                    const typeBadge = tx.tx_type && tx.tx_type !== 'Unknown' ? `<span class="tx-type-badge">${esc(tx.tx_type)}</span>` : '';
                    const feeEst = tx.fee_rate && tx.vsize ? Math.round(tx.fee_rate * tx.vsize) : null;
                    const spamDetails = isSpam ? `<div class="tx-detail-row"><span class="tx-detail-label">Spam Score</span><span class="tx-detail-value">${tx.spam_score}/100${tx.spam_flags ? ' (' + getSpamReasons(tx.spam_flags) + ')' : ''}</span></div>` : '';
                    const details = tx.hex ? `
                        <div class="tx-details">
                            <div class="tx-detail-row"><span class="tx-detail-label">Inputs / Outputs</span><span class="tx-detail-value">${tx.input_count || '?'}  ${tx.output_count || '?'}</span></div>
                            <div class="tx-detail-row"><span class="tx-detail-label">Size / vSize</span><span class="tx-detail-value">${tx.size}B / ${tx.vsize || tx.size}vB</span></div>
                            ${feeEst ? `<div class="tx-detail-row"><span class="tx-detail-label">Est. Fee</span><span class="tx-detail-value">${feeEst.toLocaleString()} sat</span></div>` : ''}
                            ${tx.locktime ? `<div class="tx-detail-row"><span class="tx-detail-label">Locktime</span><span class="tx-detail-value">${tx.locktime}</span></div>` : ''}
                            ${tx.witness_size ? `<div class="tx-detail-row"><span class="tx-detail-label">Witness Size</span><span class="tx-detail-value">${(tx.witness_size/1024).toFixed(1)}KB</span></div>` : ''}
                            <div class="tx-detail-row"><span class="tx-detail-label">Version</span><span class="tx-detail-value">${tx.version || '?'}</span></div>
                            ${spamDetails}
                            <div class="tx-actions">
                                <button class="tx-action-btn" onclick="event.stopPropagation();copyToClipboard('${tx.txid}',this)">Copy txid</button>
                                <button class="tx-action-btn" onclick="event.stopPropagation();copyToClipboard('${tx.hex}',this)">Copy raw hex</button>
                            </div>
                            <div class="tx-hex" style="margin-top:8px">${esc(tx.hex)}</div>
                        </div>` : '<div class="tx-details"><div class="tx-size">Raw data not available</div></div>';
                    const feeStr = tx.fee_rate !== undefined ? `${tx.fee_rate.toFixed(1)} sat/vB` : '';
                    const isExpanded = expandedTxids.has(tx.txid) ? ' expanded' : '';
                    return `
                    <div class="tx-item ${feeClass}${spamClass}${isExpanded}" onclick="toggleTxExpand(this, '${tx.txid}')">
                        <div class="tx-id">${esc(tx.txid)}${typeBadge}${spamIcon}</div>
                        <div class="tx-meta">
                            <span>${esc(String(tx.sources))} peer(s)${tx.size ? '  ' + tx.size + 'B' : ''}${feeStr ? '  ' + feeStr : ''}</span>
                            <span>${esc(new Date(tx.first_seen * 1000).toLocaleTimeString())}</span>
                        </div>
                        <div class="tx-propagation">propagation: ${esc(propStr)}</div>
                        ${details}
                    </div>
                `}).join('');
            }
        }

        function renderTxListDetail(force) {
            // Skip re-render if any transaction is expanded (unless forced)
            if (!force && expandedTxids.size > 0) return;
            const filterEl = document.getElementById('tx-search-detail');
            const filter = filterEl ? filterEl.value.toLowerCase() : '';
            const hideSpamEl = document.getElementById('hide-spam-detail');
            const hideSpam = hideSpamEl ? hideSpamEl.checked : false;
            let filtered = lastTxs.filter(tx => !filter || tx.txid.toLowerCase().startsWith(filter));
            if (hideSpam) filtered = filtered.filter(tx => (tx.spam_score || 0) < 30);
            const txList = document.getElementById('tx-list-detail');
            if (!txList) return;
            if (filtered.length === 0) {
                txList.innerHTML = '<div class="empty">' + (filter || hideSpam ? 'No matching transactions' : 'No transactions yet') + '</div>';
            } else {
                txList.innerHTML = filtered.slice(0, parseInt(appSettings.maxTxs) || 50).map((tx, i) => {
                    const delays = tx.delays || [];
                    const propStr = delays.length > 0
                        ? delays.slice(0, 5).map(d => d + 's').join(', ') + (delays.length > 5 ? '...' : '')
                        : '-';
                    const feeClass = getFeeClass(tx.fee_rate);
                    const isSpam = (tx.spam_score || 0) >= 30;
                    const spamClass = isSpam ? ' spam' : '';
                    const spamIcon = isSpam ? getSpamIcon(tx) : '';
                    const typeBadge = tx.tx_type && tx.tx_type !== 'Unknown' ? `<span class="tx-type-badge">${esc(tx.tx_type)}</span>` : '';
                    const feeEst = tx.fee_rate && tx.vsize ? Math.round(tx.fee_rate * tx.vsize) : null;
                    const spamDetails = isSpam ? `<div class="tx-detail-row"><span class="tx-detail-label">Spam Score</span><span class="tx-detail-value">${tx.spam_score}/100${tx.spam_flags ? ' (' + getSpamReasons(tx.spam_flags) + ')' : ''}</span></div>` : '';
                    const details = tx.hex ? `
                        <div class="tx-details">
                            <div class="tx-detail-row"><span class="tx-detail-label">Inputs / Outputs</span><span class="tx-detail-value">${tx.input_count || '?'}  ${tx.output_count || '?'}</span></div>
                            <div class="tx-detail-row"><span class="tx-detail-label">Size / vSize</span><span class="tx-detail-value">${tx.size}B / ${tx.vsize || tx.size}vB</span></div>
                            ${feeEst ? `<div class="tx-detail-row"><span class="tx-detail-label">Est. Fee</span><span class="tx-detail-value">${feeEst.toLocaleString()} sat</span></div>` : ''}
                            ${tx.locktime ? `<div class="tx-detail-row"><span class="tx-detail-label">Locktime</span><span class="tx-detail-value">${tx.locktime}</span></div>` : ''}
                            ${tx.witness_size ? `<div class="tx-detail-row"><span class="tx-detail-label">Witness Size</span><span class="tx-detail-value">${(tx.witness_size/1024).toFixed(1)}KB</span></div>` : ''}
                            <div class="tx-detail-row"><span class="tx-detail-label">Version</span><span class="tx-detail-value">${tx.version || '?'}</span></div>
                            ${spamDetails}
                            <div class="tx-actions">
                                <button class="tx-action-btn" onclick="event.stopPropagation();copyToClipboard('${tx.txid}',this)">Copy txid</button>
                                <button class="tx-action-btn" onclick="event.stopPropagation();copyToClipboard('${tx.hex}',this)">Copy raw hex</button>
                            </div>
                            <div class="tx-hex" style="margin-top:8px">${esc(tx.hex)}</div>
                        </div>` : '<div class="tx-details"><div class="tx-size">Raw data not available</div></div>';
                    const feeStr = tx.fee_rate !== undefined ? `${tx.fee_rate.toFixed(1)} sat/vB` : '';
                    const isExpanded = expandedTxids.has(tx.txid) ? ' expanded' : '';
                    return `
                    <div class="tx-item ${feeClass}${spamClass}${isExpanded}" onclick="toggleTxExpand(this, '${tx.txid}')">
                        <div class="tx-id">${esc(tx.txid)}${typeBadge}${spamIcon}</div>
                        <div class="tx-meta">
                            <span>${esc(String(tx.sources))} peer(s)${tx.size ? '  ' + tx.size + 'B' : ''}${feeStr ? '  ' + feeStr : ''}</span>
                            <span>${esc(new Date(tx.first_seen * 1000).toLocaleTimeString())}</span>
                        </div>
                        <div class="tx-propagation">propagation: ${esc(propStr)}</div>
                        ${details}
                    </div>
                `}).join('');
            }
        }

        function getSpamIcon(tx) {
            const flags = tx.spam_flags || {};
            let title = 'Potential spam';
            if (flags.inscription) title = 'Inscription detected';
            else if (flags.dust) title = 'Dust outputs';
            else if (flags.op_return) title = 'OP_RETURN data';
            else if (flags.low_fee) title = 'Very low fee';
            return `<span class="spam-icon" title="${title}"></span>`;
        }

        function getSpamReasons(flags) {
            const reasons = [];
            if (flags.dust) reasons.push('dust');
            if (flags.op_return) reasons.push('OP_RETURN');
            if (flags.inscription) reasons.push('inscription');
            if (flags.low_fee) reasons.push('low fee');
            return reasons.join(', ');
        }

        function setStatus(status) {
            const el = document.getElementById('ws-status');
            el.className = 'ws-status ' + status;
            el.textContent = status === 'connected' ? 'Connected' :
                             status === 'connecting' ? 'Connecting...' : 'Disconnected';
        }

        function connect() {
            setStatus('connecting');
            ws = new WebSocket('ws://' + window.location.host + '/ws');
            ws.onopen = () => setStatus('connected');
            ws.onclose = () => {
                setStatus('disconnected');
                setTimeout(connect, 2000);
            };
            ws.onerror = () => ws.close();
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    lastData = data;
                    updateBlocktimeChart(data.block);
                    if (data.block && data.block.hash && data.block.hash !== lastBlockHash) {
                        if (lastBlockHash !== null) showBlockNotification();
                        lastBlockHash = data.block.hash;
                    }
                    updateUI(data);
                    updateTxsizeChart(data.recent_txs);
                    updateFeeCharts(data.fee_stats);
                    updateSpamCharts(data.spam_stats);
                    updateConnectionStats(data.connection_stats);
                    updateMsgTypes(data.msg_types);
                    updateQualityChart(data.peer_quality);
                    updateTopology(data.topology);
                    updateMap(data.node_list);
                    updateUaChart(data.user_agents);
                    renderBannedList(data.banned_peers || []);
                    if (currentTab === 'nodes') renderNodeListDetail(data.node_list || []);
                    if (currentTab === 'transactions') renderTxListDetail();
                    updateDetailPanels(data);
                } catch (e) {
                    console.error('Parse error:', e);
                }
            };
        }

        initTheme();
        initTabs();
        initChart();
        initUaChart();
        initBlocktimeChart();
        initTxsizeChart();
        initFeeCharts();
        initQualityChart();
        initSpamCharts();
        initBandwidthChart();
        initMsgTypeChart();
        initMap();
        connect();
        document.getElementById('tx-search').addEventListener('input', renderTxList);
        document.getElementById('tx-search-detail').addEventListener('input', () => renderTxListDetail(true));
    </script>
</body>
</html>
